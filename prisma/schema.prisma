// TutorAI Database Schema
// Multi-tenant AI Tutoring Platform

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// DISTRICT MODEL - Groups multiple schools
// ============================================

model District {
  id                 String   @id @default(cuid())
  name               String
  code               String   @unique // e.g., "USD-001"
  state              String
  address            String?
  city               String?
  zipCode            String?
  phone              String?
  email              String?
  website            String?
  logoUrl            String?

  superintendent     String?  // Name of superintendent

  schools            School[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  isActive           Boolean  @default(true)
}

// ============================================
// SCHOOL TYPES
// ============================================
// Stored as String in SQLite, validated in application
// PRESCHOOL, KINDERGARTEN, ELEMENTARY, MIDDLE_SCHOOL,
// HIGH_SCHOOL, VOCATIONAL_TECH, K8, K12, CHARTER, MAGNET

// ============================================
// MULTI-TENANT: SCHOOL MODEL
// ============================================

model School {
  id                 String   @id @default(cuid())
  name               String
  domain             String?  @unique

  // District relationship
  districtId         String?
  district           District? @relation(fields: [districtId], references: [id])

  // School classification
  schoolType         String   @default("ELEMENTARY") // PRESCHOOL, KINDERGARTEN, ELEMENTARY, MIDDLE_SCHOOL, HIGH_SCHOOL, VOCATIONAL_TECH, K8, K12
  gradeMin           Int      @default(0)  // Minimum grade served (PK=-1, K=0, 1-12)
  gradeMax           Int      @default(5)  // Maximum grade served

  address            String?
  city               String?
  state              String?
  zipCode            String?
  country            String   @default("USA")
  phone              String?
  email              String?
  website            String?
  logoUrl            String?

  subscriptionTier   String   @default("FREE")
  subscriptionStatus String   @default("ACTIVE")
  trialEndsAt        DateTime?

  timezone           String   @default("America/New_York")
  gradeRange         String?  // Legacy field for display

  users              User[]
  classes            Class[]
  departments        Department[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  isActive           Boolean  @default(true)
}

// ============================================
// DEPARTMENT MODEL - For department heads
// ============================================

model Department {
  id                 String   @id @default(cuid())
  name               String   // e.g., "Mathematics Department"
  code               String   // e.g., "MATH"
  schoolId           String
  school             School   @relation(fields: [schoolId], references: [id])

  categoryId         String?  // Link to SubjectCategory

  headId             String?  // Department head (User with DEPARTMENT_HEAD role)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  isActive           Boolean  @default(true)

  @@unique([schoolId, code])
}

// ============================================
// USER MODEL
// ============================================

// ============================================
// USER ROLES (stored as String, validated in app)
// ============================================
// SUPER_ADMIN (100)     - Platform owner
// DISTRICT_ADMIN (90)   - Oversees multiple schools
// PRINCIPAL (85)        - School leadership
// VICE_PRINCIPAL (75)   - Assistant principal
// DEPARTMENT_HEAD (65)  - Lead teacher, curriculum oversight
// TEACHER (60)          - Classroom instruction
// STUDENT (40)          - Learning

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  passwordHash       String?
  firstName          String
  lastName           String
  role               String    @default("STUDENT") // See roles above

  schoolId           String?
  school             School?   @relation(fields: [schoolId], references: [id])

  // For DISTRICT_ADMIN - which district they manage
  districtId         String?

  // For DEPARTMENT_HEAD - which department they lead
  departmentCode     String?   // Links to Department.code

  // Teacher/Staff specific fields
  employeeId         String?   // School employee ID
  certifications     String?   // JSON array of certifications
  hireDate           DateTime?

  // Student specific fields
  gradeLevel         Int?
  studentId          String?   // School student ID

  // Preferences
  preferredVoice     String?
  preferredLanguage  String    @default("en")
  textSize           String    @default("normal")
  highContrast       Boolean   @default(false)
  dyslexiaFont       Boolean   @default(false)

  // WCAG 2.1 AA Accessibility Settings
  reducedMotion      Boolean   @default(false)
  focusHighlight     Boolean   @default(true)
  screenReaderMode   Boolean   @default(false)
  keyboardNav        Boolean   @default(true)
  colorBlindMode     String    @default("none") // none, protanopia, deuteranopia, tritanopia
  lineSpacing        String    @default("normal") // normal, wide, extra-wide
  cursorSize         String    @default("normal") // normal, large
  autoplayMedia      Boolean   @default(true)

  isActive           Boolean   @default(true)
  emailVerified      Boolean   @default(false)
  lastLoginAt        DateTime?

  tutoringSessionsAsStudent TutoringSession[]
  classesAsStudent   ClassStudent[]
  classesAsTeacher   ClassTeacher[]
  progress           StudentProgress[]
  uploads            Upload[]

  // Relations for lessons, assignments, quizzes
  lessonsCreated     Lesson[]       @relation("LessonCreator")
  assignmentsCreated Assignment[]   @relation("AssignmentCreator")
  individualAssignments Assignment[] @relation("IndividualAssignments")
  submissions        Submission[]   @relation("StudentSubmissions")
  submissionsGraded  Submission[]   @relation("SubmissionGrader")
  quizzesCreated     Quiz[]         @relation("QuizCreator")
  quizAttempts       QuizAttempt[]  @relation("QuizAttempts")

  // Subscription and Trial relations
  subscriptions      Subscription[]
  trialCodes         TrialCode[]

  // Two-Factor Authentication (2FA)
  twoFactorEnabled   Boolean   @default(false)
  twoFactorSecret    String?   // Encrypted TOTP secret
  twoFactorBackupCodes String? // JSON array of backup codes (hashed)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// CLASS MODELS
// ============================================

model Class {
  id                 String    @id @default(cuid())
  name               String
  schoolId           String
  school             School    @relation(fields: [schoolId], references: [id])
  subjectId          String?
  subject            Subject?  @relation(fields: [subjectId], references: [id])
  gradeLevel         Int?
  academicYear       String?
  description        String?

  students           ClassStudent[]
  teachers           ClassTeacher[]

  // New relations for lessons, assignments, quizzes
  lessons            Lesson[]
  assignments        Assignment[]
  quizzes            Quiz[]

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  isActive           Boolean   @default(true)
}

model ClassStudent {
  id                 String    @id @default(cuid())
  classId            String
  class              Class     @relation(fields: [classId], references: [id])
  studentId          String
  student            User      @relation(fields: [studentId], references: [id])
  enrolledAt         DateTime  @default(now())

  @@unique([classId, studentId])
}

model ClassTeacher {
  id                 String    @id @default(cuid())
  classId            String
  class              Class     @relation(fields: [classId], references: [id])
  teacherId          String
  teacher            User      @relation(fields: [teacherId], references: [id])
  isPrimary          Boolean   @default(false)
  assignedAt         DateTime  @default(now())

  @@unique([classId, teacherId])
}

// ============================================
// CURRICULUM MODELS
// ============================================

model SubjectCategory {
  id                 String    @id @default(cuid())
  code               String    @unique
  name               String
  description        String?
  icon               String?
  color              String?
  order              Int       @default(0)
  isActive           Boolean   @default(true)

  subjects           Subject[]

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Subject {
  id                 String    @id @default(cuid())
  code               String    @unique
  name               String
  description        String?
  categoryId         String
  category           SubjectCategory @relation(fields: [categoryId], references: [id])
  gradeRange         String?
  order              Int       @default(0)
  isActive           Boolean   @default(true)

  topics             Topic[]
  classes            Class[]
  sessions           TutoringSession[]

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Topic {
  id                 String    @id @default(cuid())
  code               String    @unique
  name               String
  description        String?
  subjectId          String
  subject            Subject   @relation(fields: [subjectId], references: [id])
  gradeLevel         Int?
  difficulty         Int       @default(1)
  order              Int       @default(0)
  isActive           Boolean   @default(true)

  sessions           TutoringSession[]
  progress           StudentProgress[]

  // New relations for lessons, assignments, quizzes
  lessons            Lesson[]
  assignments        Assignment[]
  quizzes            Quiz[]

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// SESSION MODELS
// ============================================

model TutoringSession {
  id                 String    @id @default(cuid())
  studentId          String
  student            User      @relation(fields: [studentId], references: [id])
  subjectId          String?
  subject            Subject?  @relation(fields: [subjectId], references: [id])
  topicId            String?
  topic              Topic?    @relation(fields: [topicId], references: [id])
  gradeLevel         Int?

  // Lesson context for AI - allows tutoring based on specific lesson content
  lessonId           String?
  lesson             Lesson?   @relation(fields: [lessonId], references: [id])

  mode               String    @default("TEXT")
  status             String    @default("ACTIVE")
  startedAt          DateTime  @default(now())
  endedAt            DateTime?
  duration           Int?
  summary            String?

  messages           SessionMessage[]

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model SessionMessage {
  id                 String    @id @default(cuid())
  sessionId          String
  session            TutoringSession @relation(fields: [sessionId], references: [id])
  role               String    @default("USER")
  content            String
  visualAids         String?
  uploadId           String?
  upload             Upload?   @relation(fields: [uploadId], references: [id])

  createdAt          DateTime  @default(now())
}

// ============================================
// UPLOAD MODEL
// ============================================

model Upload {
  id                 String    @id @default(cuid())
  userId             String
  user               User      @relation(fields: [userId], references: [id])
  sessionId          String?
  filename           String
  originalName       String
  mimeType           String
  size               Int
  storageUrl         String
  processingStatus   String    @default("PENDING")
  extractedText      String?

  messages           SessionMessage[]

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// PROGRESS MODEL
// ============================================

model StudentProgress {
  id                 String    @id @default(cuid())
  studentId          String
  student            User      @relation(fields: [studentId], references: [id])
  topicId            String
  topic              Topic     @relation(fields: [topicId], references: [id])
  masteryLevel       Int       @default(0)
  totalTime          Int       @default(0)
  questionsAttempted Int       @default(0)
  questionsCorrect   Int       @default(0)
  lastActivityAt     DateTime  @default(now())

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([studentId, topicId])
}

// ============================================
// CONFIG MODELS
// ============================================

model AIConfig {
  id                 String    @id @default("default")
  provider           String    @default("openai")
  model              String    @default("gpt-4")
  temperature        Float     @default(0.7)
  maxTokens          Int       @default(1024)
  voiceId            String    @default("alloy")
  enableVoice        Boolean   @default(true)
  enableVision       Boolean   @default(true)
  enableRealtime     Boolean   @default(true)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Language {
  id                 String    @id @default(cuid())
  code               String    @unique
  name               String
  nativeName         String
  enabled            Boolean   @default(true)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Branding {
  id                 String    @id @default("default")
  logoUrl            String    @default("")
  faviconUrl         String    @default("")
  primaryColor       String    @default("#0ea5e9")
  secondaryColor     String    @default("#0284c7")
  accentColor        String    @default("#38bdf8")
  headingFont        String    @default("Inter")
  bodyFont           String    @default("Inter")
  customCss          String?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Greeting {
  id                 String    @id @default("default")
  welcomeTitle       String    @default("Welcome to TutorAI!")
  welcomeMessage     String    @default("I'm your AI tutor. What would you like to learn today?")
  voiceGreeting      String    @default("Hello! I'm your AI tutor. How can I help you today?")

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model StoreInfo {
  id                 String    @id @default("default")
  businessName       String    @default("TutorAI")
  tagline            String    @default("AI-Powered Learning for Every Student")
  description        String    @default("")
  address            String    @default("")
  phone              String    @default("")
  email              String    @default("")
  website            String    @default("")
  businessHours      String    @default("")
  timezone           String    @default("America/New_York")

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// KNOWLEDGE BASE
// ============================================

model KnowledgeDocument {
  id                 String    @id @default(cuid())
  title              String
  content            String
  category           String    @default("general")
  subjectId          String?
  topicId            String?
  tags               String?
  isActive           Boolean   @default(true)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// LOGIC RULES
// ============================================

model LogicRule {
  id                 String    @id @default(cuid())
  name               String
  description        String?
  condition          String
  action             String
  priority           Int       @default(0)
  isActive           Boolean   @default(true)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// FUNCTIONS
// ============================================

model AIFunction {
  id                 String    @id @default(cuid())
  name               String    @unique
  description        String?
  parameters         String?
  triggerType        String    @default("manual")
  isActive           Boolean   @default(true)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// LESSON MODEL - Teacher-created content
// ============================================

model Lesson {
  id                 String    @id @default(cuid())
  code               String    @unique
  title              String
  description        String?
  content            String    // Rich text/markdown content

  // Learning objectives (JSON array)
  objectives         String?   // ["Understand X", "Apply Y", "Analyze Z"]

  // Lesson materials and resources
  materials          String?   // JSON array of resource links/files
  prerequisites      String?   // JSON array of prerequisite lesson codes

  topicId            String
  topic              Topic     @relation(fields: [topicId], references: [id])
  classId            String?
  class              Class?    @relation(fields: [classId], references: [id])

  gradeLevel         Int?      // Target grade level
  duration           Int?      // Estimated minutes
  order              Int       @default(0)

  // System-generated vs teacher-created
  isSystemLesson     Boolean   @default(false)  // True for pre-seeded curriculum lessons

  createdById        String
  createdBy          User      @relation("LessonCreator", fields: [createdById], references: [id])

  assignments        Assignment[]
  tutoringSessions   TutoringSession[]  // AI tutoring sessions using this lesson

  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// ASSIGNMENT MODEL - Teacher-assigned work
// ============================================

model Assignment {
  id                 String    @id @default(cuid())
  code               String    @unique
  title              String
  instructions       String

  lessonId           String?
  lesson             Lesson?   @relation(fields: [lessonId], references: [id])
  topicId            String
  topic              Topic     @relation(fields: [topicId], references: [id])

  // Can assign to class OR individual student
  classId            String?
  class              Class?    @relation(fields: [classId], references: [id])
  studentId          String?   // For individual assignments
  student            User?     @relation("IndividualAssignments", fields: [studentId], references: [id])

  type               String    @default("homework") // homework, project, practice
  dueDate            DateTime?
  maxPoints          Int       @default(100)
  allowLate          Boolean   @default(true)

  createdById        String
  createdBy          User      @relation("AssignmentCreator", fields: [createdById], references: [id])

  submissions        Submission[]

  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// SUBMISSION MODEL - Student assignment submissions
// ============================================

model Submission {
  id                 String    @id @default(cuid())

  assignmentId       String
  assignment         Assignment @relation(fields: [assignmentId], references: [id])
  studentId          String
  student            User      @relation("StudentSubmissions", fields: [studentId], references: [id])

  content            String?   // Text response
  attachments        String?   // JSON array of upload IDs

  submittedAt        DateTime  @default(now())
  isLate             Boolean   @default(false)

  grade              Int?      // 0-100
  feedback           String?
  gradedAt           DateTime?
  gradedById         String?
  gradedBy           User?     @relation("SubmissionGrader", fields: [gradedById], references: [id])

  status             String    @default("submitted") // draft, submitted, graded, returned

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([assignmentId, studentId])
}

// ============================================
// QUIZ MODEL - Assessment tool
// ============================================

model Quiz {
  id                 String    @id @default(cuid())
  code               String    @unique
  title              String
  description        String?

  topicId            String
  topic              Topic     @relation(fields: [topicId], references: [id])
  classId            String?
  class              Class?    @relation(fields: [classId], references: [id])

  timeLimit          Int?      // Minutes, null = unlimited
  passingScore       Int       @default(70) // Percentage
  maxAttempts        Int       @default(3)
  randomize          Boolean   @default(false)
  showAnswers        Boolean   @default(true) // Show correct answers after

  createdById        String
  createdBy          User      @relation("QuizCreator", fields: [createdById], references: [id])

  questions          QuizQuestion[]
  attempts           QuizAttempt[]

  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// QUIZ QUESTION MODEL
// ============================================

model QuizQuestion {
  id                 String    @id @default(cuid())

  quizId             String
  quiz               Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)

  questionNum        Int
  questionText       String
  questionType       String    // multiple_choice, true_false, fill_blank
  options            String?   // JSON array for multiple choice
  correctAnswer      String
  explanation        String?
  points             Int       @default(1)

  answers            QuizAnswer[]

  @@unique([quizId, questionNum])
}

// ============================================
// QUIZ ATTEMPT MODEL - Student quiz sessions
// ============================================

model QuizAttempt {
  id                 String    @id @default(cuid())

  quizId             String
  quiz               Quiz      @relation(fields: [quizId], references: [id])
  studentId          String
  student            User      @relation("QuizAttempts", fields: [studentId], references: [id])

  attemptNum         Int       @default(1)
  startedAt          DateTime  @default(now())
  submittedAt        DateTime?

  score              Int?      // Points earned
  percentage         Float?    // Score percentage
  passed             Boolean?

  answers            QuizAnswer[]

  status             String    @default("in_progress") // in_progress, submitted, graded

  @@unique([quizId, studentId, attemptNum])
}

// ============================================
// QUIZ ANSWER MODEL - Individual responses
// ============================================

model QuizAnswer {
  id                 String    @id @default(cuid())

  attemptId          String
  attempt            QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId         String
  question           QuizQuestion @relation(fields: [questionId], references: [id])

  answer             String?
  isCorrect          Boolean?
  pointsEarned       Int?

  answeredAt         DateTime  @default(now())
}

// ============================================
// PAYMENT GATEWAY CONFIGURATION
// ============================================

model PaymentGateway {
  id                  String   @id @default(cuid())
  provider            String   @default("stripe") @unique // stripe, paypal, braintree, square, authorize
  isEnabled           Boolean  @default(false)
  testMode            Boolean  @default(true)

  // Stripe fields
  publishableKey      String?
  secretKey           String?
  webhookSecret       String?
  achEnabled          Boolean  @default(false)

  // PayPal fields
  clientId            String?
  clientSecret        String?
  webhookId           String?

  // Braintree fields
  merchantId          String?
  publicKey           String?
  privateKey          String?

  // Square fields
  applicationId       String?
  accessToken         String?
  locationId          String?
  webhookSignatureKey String?

  // Authorize.net fields
  apiLoginId          String?
  transactionKey      String?
  signatureKey        String?

  additionalConfig    String   @default("{}") // JSON for provider-specific settings
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// ============================================
// PAYMENT/SUBSCRIPTION RECORDS
// ============================================

model Payment {
  id                 String    @id @default(cuid())
  amount             Float
  currency           String    @default("USD")
  status             String    @default("pending") // pending, completed, failed, refunded
  method             String?   // card, bank, paypal
  gateway            String?   // stripe, paypal, braintree, square, authorize
  transactionId      String?
  description        String?

  schoolId           String?
  userId             String?

  subscriptionPlan   String?   // basic, standard, premium, school
  billingPeriod      String?   // monthly, yearly

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ============================================
// SUBSCRIPTION PLANS
// ============================================

model SubscriptionPlan {
  id                 String    @id @default(cuid())
  name               String
  code               String    @unique // basic, standard, premium, school
  description        String?
  price              Float     @default(0)
  currency           String    @default("USD")
  billingPeriod      String    @default("monthly") // monthly, yearly
  sessionsPerMonth   Int?      // null = unlimited
  subjectsAllowed    Int?      // null = all
  features           String?   // JSON array of features
  isActive           Boolean   @default(true)
  sortOrder          Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  subscriptions      Subscription[]
}

// ============================================
// USER SUBSCRIPTIONS
// ============================================

model Subscription {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id])
  planId                String
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])

  stripeSubscriptionId  String?
  stripeCustomerId      String?

  status                String    @default("active") // active, canceled, past_due, trialing
  trialEndsAt           DateTime?
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  canceledAt            DateTime?
  endedAt               DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// ============================================
// TRIAL CODES
// ============================================

model TrialCode {
  id                    String    @id @default(cuid())
  code                  String    @unique

  requesterFirstName    String
  requesterLastName     String
  requesterEmail        String
  requesterPhone        String?
  requesterOrganization String?

  deliveryMethod        String    @default("email") // email, sms
  durationDays          Int       @default(14)

  status                String    @default("pending") // pending, sent, redeemed, expired, revoked

  userId                String?
  user                  User?     @relation(fields: [userId], references: [id])

  redeemedAt            DateTime?
  expiresAt             DateTime
  revokedAt             DateTime?
  revokedReason         String?

  extensionCount        Int       @default(0)
  parentCodeId          String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// ============================================
// PAYMENT SETTINGS (Unified gateway config)
// ============================================

model PaymentSettings {
  id                      String   @id @default(cuid())
  enabled                 Boolean  @default(false)
  // Stripe
  stripeEnabled           Boolean  @default(false)
  stripePublishableKey    String   @default("")
  stripeSecretKey         String   @default("")
  stripeTestMode          Boolean  @default(true)
  stripeWebhookSecret     String   @default("")
  // PayPal
  paypalEnabled           Boolean  @default(false)
  paypalClientId          String   @default("")
  paypalClientSecret      String   @default("")
  paypalSandbox           Boolean  @default(true)
  paypalWebhookId         String   @default("")
  // Square
  squareEnabled           Boolean  @default(false)
  squareAppId             String   @default("")
  squareAccessToken       String   @default("")
  squareLocationId        String   @default("")
  squareSandbox           Boolean  @default(true)
  squareWebhookSignature  String   @default("")
  // Braintree
  braintreeEnabled        Boolean  @default(false)
  braintreeMerchantId     String   @default("")
  braintreePublicKey      String   @default("")
  braintreePrivateKey     String   @default("")
  braintreeTestMode       Boolean  @default(true)
  // Authorize.net
  authorizeEnabled        Boolean  @default(false)
  authorizeApiLoginId     String   @default("")
  authorizeTransactionKey String   @default("")
  authorizeTestMode       Boolean  @default(true)
  authorizeSignatureKey   String   @default("")
  updatedAt               DateTime @updatedAt
}

// ============================================
// SMS CONFIGURATION (Twilio)
// ============================================

model SMSConfig {
  id                    String   @id @default("default")
  isEnabled             Boolean  @default(false)

  // Twilio Configuration
  accountSid            String   @default("")
  authToken             String   @default("")
  phoneNumber           String   @default("")

  // Notification toggles
  sessionReminders      Boolean  @default(true)
  progressUpdates       Boolean  @default(true)
  achievementAlerts     Boolean  @default(false)
  teacherAlerts         Boolean  @default(false)

  // Message Templates
  sessionReminderTemplate   String   @default("Hi {student_name}! Your tutoring session for {subject} starts in 15 minutes. See you soon!")
  progressUpdateTemplate    String   @default("Weekly update for {student_name}: Completed {sessions} sessions, {mastery}% mastery improvement in {subject}.")
  achievementTemplate       String   @default("Congratulations {student_name}! You've achieved a new milestone in {subject}!")
  teacherAlertTemplate      String   @default("Alert: Student {student_name} may need additional support in {subject}.")

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// WEBHOOKS
// ============================================

model Webhook {
  id                    String   @id @default(cuid())
  name                  String
  url                   String
  secret                String?  // For request signing
  events                String   // JSON array of event types
  isActive              Boolean  @default(true)
  lastTriggeredAt       DateTime?
  failureCount          Int      @default(0)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id                    String   @id @default(cuid())
  userId                String
  type                  String   // info, success, warning, error
  title                 String
  message               String
  link                  String?  // Optional URL to navigate to
  isRead                Boolean  @default(false)
  readAt                DateTime?

  createdAt             DateTime @default(now())
}

// ============================================
// MESSAGES (Student-Teacher Communication)
// ============================================

model Message {
  id                    String   @id @default(cuid())
  senderId              String
  receiverId            String
  subject               String?
  content               String
  isRead                Boolean  @default(false)
  readAt                DateTime?

  // Optional attachments (JSON array of Upload IDs)
  attachments           String?

  // For threading
  parentId              String?  // Reply to message ID

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// PASSWORD RESET TOKENS
// ============================================

model PasswordResetToken {
  id                    String   @id @default(cuid())
  userId                String
  token                 String   @unique
  expiresAt             DateTime
  usedAt                DateTime?

  createdAt             DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// ============================================
// EMAIL VERIFICATION TOKENS
// ============================================

model EmailVerificationToken {
  id                    String   @id @default(cuid())
  userId                String
  token                 String   @unique
  expiresAt             DateTime
  verifiedAt            DateTime?

  createdAt             DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// ============================================
// AUDIT LOG (for compliance)
// ============================================

model AuditLog {
  id                    String   @id @default(cuid())
  userId                String?  // Who performed the action (null for system)
  userEmail             String?  // Email at time of action (in case user deleted)
  action                String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entityType            String   // User, School, Assignment, etc.
  entityId              String?  // ID of affected entity
  oldValues             String?  // JSON of previous values
  newValues             String?  // JSON of new values
  ipAddress             String?
  userAgent             String?
  metadata              String?  // Additional context JSON

  createdAt             DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

// ============================================
// PARENTAL CONSENT (COPPA Compliance)
// ============================================

model ParentalConsent {
  id                    String   @id @default(cuid())
  studentId             String

  // Child information
  childDateOfBirth      DateTime
  childAge              Int      // Calculated age at time of registration

  // Parent/Guardian information
  parentFirstName       String
  parentLastName        String
  parentEmail           String
  parentPhone           String?
  relationship          String   // parent, guardian, etc.

  // Consent details
  consentToken          String   @unique // For verification
  consentStatus         String   @default("pending") // pending, verified, rejected, revoked
  consentMethod         String   @default("email") // email, signed_form, in_person

  // Verification
  verifiedAt            DateTime?
  verificationIp        String?
  signatureData         String?  // For digital signatures

  // Privacy preferences
  allowDataCollection   Boolean  @default(true)
  allowThirdPartySharing Boolean @default(false)
  allowMarketing        Boolean  @default(false)

  // Revocation
  revokedAt             DateTime?
  revokedReason         String?

  // Timestamps
  requestedAt           DateTime @default(now())
  expiresAt             DateTime // Consent request expiry
  lastUpdatedAt         DateTime @updatedAt

  @@index([studentId])
  @@index([parentEmail])
  @@index([consentToken])
  @@index([consentStatus])
}

// ============================================
// COPPA AGE VERIFICATION
// ============================================

model AgeVerification {
  id                    String   @id @default(cuid())
  userId                String   @unique
  dateOfBirth           DateTime
  ageAtRegistration     Int
  isUnder13             Boolean
  verificationMethod    String   @default("self_reported") // self_reported, parent_verified, school_verified
  verifiedAt            DateTime @default(now())

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([isUnder13])
}

// ============================================
// PARENT PORTAL
// ============================================

model ParentAccount {
  id                    String   @id @default(cuid())
  email                 String   @unique
  passwordHash          String?
  firstName             String
  lastName              String
  phone                 String?

  // Verification
  emailVerified         Boolean  @default(false)
  lastLoginAt           DateTime?

  // Notification preferences
  notifyProgress        Boolean  @default(true)
  notifyGrades          Boolean  @default(true)
  notifyAttendance      Boolean  @default(true)
  notifyMessages        Boolean  @default(true)
  notifyWeeklyDigest    Boolean  @default(true)

  // Linked children
  children              ParentStudent[]

  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([email])
}

model ParentStudent {
  id                    String   @id @default(cuid())
  parentId              String
  parent                ParentAccount @relation(fields: [parentId], references: [id])
  studentId             String
  relationship          String   @default("parent") // parent, guardian, grandparent, other

  // Consent status (linked to ParentalConsent if under 13)
  consentId             String?  // Link to ParentalConsent record

  // Access controls
  canViewGrades         Boolean  @default(true)
  canViewProgress       Boolean  @default(true)
  canViewSessions       Boolean  @default(true)
  canMessageTeachers    Boolean  @default(true)

  // Status
  isVerified            Boolean  @default(false) // Verified by school
  isPrimary             Boolean  @default(false) // Primary contact

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([parentId, studentId])
  @@index([studentId])
  @@index([parentId])
}

// ============================================
// GAMIFICATION - BADGES
// ============================================

model Badge {
  id                    String   @id @default(cuid())
  code                  String   @unique // e.g., "first_session", "streak_7", "master_math"
  name                  String   // Display name
  description           String   // How to earn this badge
  category              String   @default("achievement") // achievement, streak, mastery, social, special
  icon                  String   @default("trophy") // Bootstrap icon name
  color                 String   @default("#fbbf24") // Badge color (gold default)
  points                Int      @default(0) // Points awarded for earning this badge

  // Requirements (stored as JSON for flexibility)
  requirements          String?  // JSON: { "type": "sessions", "count": 10, "subject": "math" }

  // Rarity/tier
  tier                  String   @default("bronze") // bronze, silver, gold, platinum, diamond

  isActive              Boolean  @default(true)
  isHidden              Boolean  @default(false) // Hidden until earned (surprise badges)

  userBadges            UserBadge[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([category])
  @@index([tier])
}

model UserBadge {
  id                    String   @id @default(cuid())
  userId                String
  badgeId               String
  badge                 Badge    @relation(fields: [badgeId], references: [id])

  // Progress tracking (for badges that require multiple steps)
  progress              Int      @default(0) // Current progress
  targetProgress        Int      @default(1) // Required progress to earn

  earnedAt              DateTime? // Null if not yet earned
  isDisplayed           Boolean  @default(true) // Show on profile

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([earnedAt])
}

// ============================================
// GAMIFICATION - STREAKS
// ============================================

model Streak {
  id                    String   @id @default(cuid())
  userId                String   @unique

  // Current streak
  currentStreak         Int      @default(0)
  longestStreak         Int      @default(0)

  // Tracking
  lastActivityDate      DateTime? // Date of last qualifying activity
  streakStartDate       DateTime? // When current streak began

  // Streak freeze (allows missing a day)
  freezesRemaining      Int      @default(0)
  freezesUsed           Int      @default(0)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([currentStreak])
  @@index([longestStreak])
}

// ============================================
// GAMIFICATION - POINTS
// ============================================

model PointTransaction {
  id                    String   @id @default(cuid())
  userId                String

  amount                Int      // Positive for earned, negative for spent
  type                  String   // earned, spent, bonus, penalty, transfer
  reason                String   // Description of why points changed
  category              String   // session, quiz, assignment, badge, streak, purchase, other

  // Reference to related entity
  referenceType         String?  // Session, Quiz, Assignment, Badge, etc.
  referenceId           String?  // ID of related entity

  // Balance tracking
  balanceBefore         Int
  balanceAfter          Int

  createdAt             DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([createdAt])
}

model PointBalance {
  id                    String   @id @default(cuid())
  userId                String   @unique

  totalEarned           Int      @default(0)
  totalSpent            Int      @default(0)
  currentBalance        Int      @default(0)

  // Lifetime stats
  lifetimePoints        Int      @default(0)

  // Level calculation (based on lifetime points)
  level                 Int      @default(1)
  levelProgress         Int      @default(0) // Points toward next level
  levelRequired         Int      @default(100) // Points needed for next level

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([currentBalance])
  @@index([level])
}

model PointConfig {
  id                    String   @id @default("default")

  // Session points
  sessionComplete       Int      @default(10)
  sessionMinutes        Int      @default(1) // Points per minute

  // Quiz points
  quizComplete          Int      @default(5)
  quizPerfectScore      Int      @default(20)
  quizPassBonus         Int      @default(10)

  // Assignment points
  assignmentSubmit      Int      @default(10)
  assignmentOnTime      Int      @default(5) // Bonus for on-time
  assignmentPerfect     Int      @default(15) // A+ grade bonus

  // Mastery points
  topicMastered         Int      @default(25)
  subjectComplete       Int      @default(100)

  // Streak points
  streakDaily           Int      @default(5) // Daily streak bonus
  streakWeekly          Int      @default(25) // 7-day streak bonus
  streakMonthly         Int      @default(100) // 30-day streak bonus

  // Social points
  helpedPeer            Int      @default(10)
  receivedKudos         Int      @default(2)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// GAMIFICATION - LEADERBOARD CACHE
// ============================================

model LeaderboardEntry {
  id                    String   @id @default(cuid())
  userId                String

  // Scope
  scope                 String   // global, school, class
  scopeId               String?  // School ID or Class ID (null for global)

  // Time period
  period                String   // all_time, monthly, weekly, daily
  periodStart           DateTime // Start of the period

  // Ranking
  rank                  Int
  points                Int

  // Cached at
  calculatedAt          DateTime @default(now())

  @@unique([userId, scope, scopeId, period, periodStart])
  @@index([scope, scopeId, period])
  @@index([rank])
}

// ============================================
// ANNOUNCEMENTS
// ============================================

model Announcement {
  id                    String   @id @default(cuid())

  title                 String
  content               String   // Rich text/markdown
  type                  String   @default("info") // info, warning, success, urgent

  // Target audience
  scope                 String   @default("all") // all, school, class, role
  scopeId               String?  // School ID or Class ID
  targetRoles           String?  // JSON array of roles, null = all

  // Author
  authorId              String

  // Scheduling
  publishAt             DateTime @default(now())
  expiresAt             DateTime?

  // Pinned/featured
  isPinned              Boolean  @default(false)

  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Read tracking
  readBy                AnnouncementRead[]

  @@index([scope, scopeId])
  @@index([publishAt])
  @@index([isPinned])
}

model AnnouncementRead {
  id                    String   @id @default(cuid())
  announcementId        String
  announcement          Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId                String
  readAt                DateTime @default(now())

  @@unique([announcementId, userId])
  @@index([userId])
}

// ============================================
// ACTIVITY FEED
// ============================================

model ActivityFeed {
  id                    String   @id @default(cuid())
  userId                String

  // Activity details
  type                  String   // badge_earned, streak_milestone, quiz_completed, level_up, etc.
  title                 String
  description           String?

  // Reference
  referenceType         String?  // Badge, Quiz, Assignment, etc.
  referenceId           String?

  // Visibility
  isPublic              Boolean  @default(true) // Show on class/school feed

  // Metadata (JSON for flexible data)
  metadata              String?  // { "badgeId": "...", "points": 50 }

  createdAt             DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([isPublic, createdAt])
}

// ============================================
// TUTORING MODE CONFIGURATION
// ============================================

model TutoringConfig {
  id                    String   @id @default("default")

  // Tutoring Mode: direct, socratic, guided, adaptive
  defaultMode           String   @default("socratic")

  // Socratic Mode Settings
  socraticHintLimit     Int      @default(3)  // Max hints before revealing answer
  socraticWaitTime      Int      @default(30) // Seconds to wait for student response
  requireAttemptFirst   Boolean  @default(true) // Student must attempt before hints

  // Guided Mode Settings
  showStepByStep        Boolean  @default(true)
  allowSkipSteps        Boolean  @default(false)

  // Adaptive Mode Settings
  adjustDifficulty      Boolean  @default(true)
  difficultyThreshold   Int      @default(3) // Wrong answers before lowering difficulty

  // Encouragement Settings
  encouragementFrequency Int     @default(3) // Every N interactions
  celebrateCorrect      Boolean  @default(true)
  celebrateMilestones   Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// Session-specific hint tracking
model SessionHint {
  id                    String   @id @default(cuid())
  sessionId             String
  questionContext       String   // The question/problem being helped with
  hintLevel             Int      @default(1) // 1=gentle nudge, 2=bigger hint, 3=walkthrough
  hintContent           String   // The hint given
  studentResponse       String?  // Student's response after hint
  wasHelpful            Boolean? // Did student indicate it helped?

  createdAt             DateTime @default(now())

  @@index([sessionId])
}

// Student struggling detection
model StrugglingAlert {
  id                    String   @id @default(cuid())
  studentId             String
  sessionId             String?
  topicId               String?
  subjectId             String?

  // Alert details
  alertType             String   // repeated_wrong, long_pause, frustration_detected, help_requested
  severity              String   @default("medium") // low, medium, high, critical
  description           String

  // Metrics that triggered alert
  wrongAnswerCount      Int      @default(0)
  timeSpentSeconds      Int      @default(0)
  hintRequestCount      Int      @default(0)

  // Status
  status                String   @default("new") // new, acknowledged, resolved, dismissed
  acknowledgedBy        String?  // Teacher ID who acknowledged
  acknowledgedAt        DateTime?
  resolvedAt            DateTime?
  resolution            String?  // Notes on how it was resolved

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([studentId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

// Teacher notification preferences for alerts
model TeacherAlertPrefs {
  id                    String   @id @default(cuid())
  teacherId             String   @unique

  // Alert types to receive
  receiveStrugglingAlerts Boolean @default(true)
  receiveLowScoreAlerts   Boolean @default(true)
  receiveInactivityAlerts Boolean @default(true)
  receiveHelpRequests     Boolean @default(true)

  // Delivery methods
  alertInApp            Boolean  @default(true)
  alertEmail            Boolean  @default(false)
  alertSms              Boolean  @default(false)

  // Thresholds
  strugglingThreshold   Int      @default(3) // Wrong answers before alert
  inactivityMinutes     Int      @default(10) // Minutes of no activity
  lowScoreThreshold     Int      @default(50) // Grade percentage

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// GRADEBOOK - CATEGORIES
// ============================================

model GradeCategory {
  id                    String   @id @default(cuid())
  classId               String
  name                  String   // "Homework", "Tests", "Projects", "Participation"
  weight                Float    @default(1.0) // Percentage weight (e.g., 0.25 for 25%)
  dropLowest            Int      @default(0) // Drop N lowest grades
  color                 String?  // For UI display
  order                 Int      @default(0)

  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([classId, name])
  @@index([classId])
}

// ============================================
// GRADEBOOK - STUDENT GRADES SUMMARY
// ============================================

model GradebookEntry {
  id                    String   @id @default(cuid())
  studentId             String
  classId               String

  // Calculated grades by category (JSON: { "category_id": { "total": 95, "count": 10 } })
  categoryGrades        String?

  // Overall calculated grade
  overallGrade          Float?   // 0-100 scale
  letterGrade           String?  // A, B+, etc.
  gpa                   Float?   // 4.0 scale

  // Assignment stats
  assignmentsCompleted  Int      @default(0)
  assignmentsMissing    Int      @default(0)
  assignmentsLate       Int      @default(0)

  // Quiz stats
  quizzesCompleted      Int      @default(0)
  quizAverage           Float?

  // Timestamps
  lastCalculatedAt      DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([studentId, classId])
  @@index([classId])
  @@index([overallGrade])
}

// ============================================
// LEARNING STANDARDS
// ============================================

model Standard {
  id                    String   @id @default(cuid())
  code                  String   @unique // e.g., "CCSS.MATH.CONTENT.3.OA.A.1"
  title                 String
  description           String?
  gradeLevel            Int?     // Target grade level
  subjectArea           String?  // Math, ELA, Science, etc.
  domain                String?  // Numbers, Operations, etc.
  cluster               String?  // Grouping within domain

  // Standard set
  standardSet           String   @default("common_core") // common_core, ngss, state_specific
  state                 String?  // State code if state-specific

  // Parent-child relationship for hierarchical standards
  parentId              String?
  parent                Standard? @relation("StandardHierarchy", fields: [parentId], references: [id])
  children              Standard[] @relation("StandardHierarchy")

  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  alignments            StandardAlignment[]

  @@index([standardSet, gradeLevel])
  @@index([subjectArea])
}

// ============================================
// STANDARD ALIGNMENT
// ============================================

model StandardAlignment {
  id                    String   @id @default(cuid())
  standardId            String
  standard              Standard @relation(fields: [standardId], references: [id])

  // What is being aligned
  entityType            String   // Assignment, Quiz, Lesson, Topic
  entityId              String

  // Alignment details
  alignmentLevel        String   @default("full") // full, partial, introduction
  notes                 String?

  // Who created the alignment
  createdById           String?

  createdAt             DateTime @default(now())

  @@unique([standardId, entityType, entityId])
  @@index([entityType, entityId])
}

// ============================================
// GRADEBOOK SETTINGS
// ============================================

model GradebookSettings {
  id                    String   @id @default("default")

  // Grading scale
  gradingScale          String   @default("standard") // standard, plus_minus, pass_fail, custom
  customScale           String?  // JSON for custom scale

  // Default thresholds for letter grades
  gradeA                Float    @default(90)
  gradeAMinus           Float    @default(87)
  gradeBPlus            Float    @default(83)
  gradeB                Float    @default(80)
  gradeBMinus           Float    @default(77)
  gradeCPlus            Float    @default(73)
  gradeC                Float    @default(70)
  gradeCMinus           Float    @default(67)
  gradeDPlus            Float    @default(63)
  gradeD                Float    @default(60)
  gradeDMinus           Float    @default(57)
  // Below D- = F

  // Weighting settings
  useWeightedGrades     Boolean  @default(true)
  includeZerosInAverage Boolean  @default(true)

  // Late work policy
  lateWorkPenalty       Float    @default(0) // Percentage deduction per day
  maxLatePenalty        Float    @default(50) // Maximum percentage deduction
  gracePeriodHours      Int      @default(0) // Hours after due date before penalty

  // Display settings
  showPointsToStudents  Boolean  @default(true)
  showPercentToStudents Boolean  @default(true)
  showLetterToStudents  Boolean  @default(true)
  showClassAverage      Boolean  @default(false)
  showClassRank         Boolean  @default(false)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// DIAGNOSTIC ASSESSMENT SYSTEM
// ============================================

model DiagnosticTest {
  id                    String   @id @default(cuid())
  code                  String   @unique
  title                 String
  description           String?

  // Subject/Topic alignment
  subjectId             String?
  topicId               String?

  // Grade level range
  minGradeLevel         Int      @default(0)  // K = 0
  maxGradeLevel         Int      @default(12)

  // Test configuration
  questionCount         Int      @default(20) // Number of questions per attempt
  timeLimit             Int?     // Minutes, null = unlimited
  adaptiveDifficulty    Boolean  @default(true) // Adjust difficulty based on responses

  // Scoring
  passingScore          Int      @default(70)

  // Question pool
  questions             DiagnosticQuestion[]
  attempts              DiagnosticAttempt[]

  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([subjectId])
  @@index([minGradeLevel, maxGradeLevel])
}

model DiagnosticQuestion {
  id                    String   @id @default(cuid())
  testId                String
  test                  DiagnosticTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  // Question content
  questionText          String
  questionType          String   @default("multiple_choice") // multiple_choice, true_false, fill_blank
  options               String?  // JSON array for multiple choice
  correctAnswer         String
  explanation           String?

  // Difficulty and alignment
  difficulty            Int      @default(5) // 1-10 scale
  gradeLevel            Int?     // Target grade level for this question
  skillCode             String?  // Skill/standard this tests (e.g., "3.OA.A.1")
  skillName             String?  // Human-readable skill name

  // Metadata
  points                Int      @default(1)
  timeEstimate          Int?     // Expected seconds to answer

  responses             DiagnosticResponse[]

  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())

  @@index([testId, difficulty])
  @@index([skillCode])
}

model DiagnosticAttempt {
  id                    String   @id @default(cuid())
  testId                String
  test                  DiagnosticTest @relation(fields: [testId], references: [id])
  studentId             String

  // Timing
  startedAt             DateTime @default(now())
  completedAt           DateTime?

  // Status
  status                String   @default("in_progress") // in_progress, completed, abandoned

  // Results (calculated on completion)
  totalQuestions        Int      @default(0)
  correctAnswers        Int      @default(0)
  score                 Float?   // Percentage
  proficiencyLevel      String?  // below, approaching, proficient, advanced
  estimatedGradeLevel   Float?   // Calculated grade level (e.g., 3.5 = mid 3rd grade)

  // Responses
  responses             DiagnosticResponse[]

  // Result summary
  result                DiagnosticResult?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([studentId])
  @@index([testId, status])
  @@index([completedAt])
}

model DiagnosticResponse {
  id                    String   @id @default(cuid())
  attemptId             String
  attempt               DiagnosticAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId            String
  question              DiagnosticQuestion @relation(fields: [questionId], references: [id])

  // Response data
  answer                String?
  isCorrect             Boolean?
  timeSpentSeconds      Int?

  // For adaptive testing - track the question's difficulty when answered
  difficultyAtAnswer    Int?

  answeredAt            DateTime @default(now())

  @@unique([attemptId, questionId])
}

model DiagnosticResult {
  id                    String   @id @default(cuid())
  attemptId             String   @unique
  attempt               DiagnosticAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  studentId             String

  // Overall results
  overallScore          Float    // 0-100
  proficiencyLevel      String   // below_basic, basic, proficient, advanced
  estimatedGradeLevel   Float    // e.g., 4.5 = mid 4th grade

  // Skill breakdown (JSON: { "skill_code": { "correct": 3, "total": 5, "percentage": 60 } })
  skillBreakdown        String?

  // Identified gaps (JSON array of skill codes where student scored < 70%)
  skillGaps             String?

  // Recommendations (JSON array of recommended topics/lessons)
  recommendations       String?

  // Strengths (JSON array of skill codes where student scored >= 90%)
  strengths             String?

  calculatedAt          DateTime @default(now())

  @@index([studentId])
  @@index([proficiencyLevel])
}

model SkillGap {
  id                    String   @id @default(cuid())
  studentId             String
  subjectId             String?
  topicId               String?

  // Skill identification
  skillCode             String   // Standard code or skill identifier
  skillName             String   // Human-readable name
  gradeLevel            Int?     // Expected grade level for this skill

  // Gap assessment
  currentScore          Float    // Student's current proficiency (0-100)
  targetScore           Float    @default(70) // Target proficiency
  gapSize               Float    // targetScore - currentScore

  // Priority
  priority              String   @default("medium") // low, medium, high, critical
  isResolved            Boolean  @default(false)

  // Source
  sourceType            String   // diagnostic, quiz, assignment, tutor_session
  sourceId              String?  // ID of the source assessment

  // Recommendations
  recommendedLessons    String?  // JSON array of lesson IDs
  recommendedTopics     String?  // JSON array of topic IDs

  // Resolution tracking
  resolvedAt            DateTime?
  resolutionScore       Float?   // Score when gap was resolved

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([studentId])
  @@index([skillCode])
  @@index([priority])
  @@index([isResolved])
}
