<%- include('../layouts/teacher', { body: `
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="${typeof basePath !== 'undefined' ? basePath : ''}/teacher/assignments">Assignments</a></li>
    <li class="breadcrumb-item active">${assignment.title}</li>
  </ol>
</nav>

<!-- Assignment Header -->
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h4 class="mb-2">${assignment.title}</h4>
        <div class="d-flex gap-2 flex-wrap mb-3">
          <span class="badge bg-primary">${assignment.type}</span>
          <span class="badge bg-secondary">${assignment.maxPoints} points</span>
          ${assignment.dueDate ? '<span class="badge ' + (new Date(assignment.dueDate) < new Date() ? 'bg-danger' : 'bg-info') + '">' + (new Date(assignment.dueDate) < new Date() ? 'Overdue: ' : 'Due: ') + new Date(assignment.dueDate).toLocaleDateString() + '</span>' : '<span class="badge bg-light text-dark">No due date</span>'}
          ${assignment.allowLate ? '<span class="badge bg-success">Late OK</span>' : '<span class="badge bg-warning text-dark">No late</span>'}
        </div>
        <p class="text-muted mb-0">
          <strong>Topic:</strong> ${assignment.topic?.subject?.name || 'N/A'} - ${assignment.topic?.name || 'N/A'}
          ${assignment.lesson ? '<br><strong>Lesson:</strong> ' + assignment.lesson.title : ''}
        </p>
      </div>
      <div class="d-flex gap-2">
        <a href="${typeof basePath !== 'undefined' ? basePath : ''}/teacher/assignments/${assignment.id}/edit" class="btn btn-outline-primary">
          <i class="bi bi-pencil me-2"></i>Edit
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Instructions -->
  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-list-task me-2"></i>Instructions</h6>
      </div>
      <div class="card-body">
        <div style="white-space: pre-wrap;">${assignment.instructions}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-people me-2"></i>Assigned To</h6>
      </div>
      <div class="card-body">
        ${assignment.studentId ? '<span class="badge bg-info fs-6">' + (assignment.student?.firstName + ' ' + assignment.student?.lastName) + '</span><br><small class="text-muted">Individual assignment</small>' : (assignment.class ? '<span class="badge bg-primary fs-6">' + assignment.class.name + '</span><br><small class="text-muted">' + (expectedStudents?.length || 0) + ' students</small>' : '<span class="text-muted">No one assigned</span>')}
      </div>
    </div>
  </div>

  <!-- Submissions -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-inbox me-2"></i>Submissions</h6>
        <span class="badge bg-primary">${assignment.submissions?.length || 0} / ${expectedStudents?.length || 0}</span>
      </div>
      <div class="card-body p-0">
        ${assignment.submissions && assignment.submissions.length > 0 ? '<div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Student</th><th>Submitted</th><th>Status</th><th>Grade</th><th>Actions</th></tr></thead><tbody>' + assignment.submissions.map(s => '<tr><td><strong>' + s.student.firstName + ' ' + s.student.lastName + '</strong><br><small class="text-muted">' + s.student.email + '</small></td><td>' + new Date(s.submittedAt).toLocaleString() + (s.isLate ? '<br><span class="badge bg-warning text-dark">Late</span>' : '') + '</td><td><span class="badge ' + (s.status === 'graded' ? 'bg-success' : (s.status === 'submitted' ? 'bg-info' : 'bg-secondary')) + '">' + s.status + '</span></td><td>' + (s.grade !== null ? '<strong>' + s.grade + '</strong>/' + assignment.maxPoints + '<br><small class="text-muted">by ' + (s.gradedBy?.firstName || 'Unknown') + '</small>' : '<span class="text-muted">Not graded</span>') + '</td><td><button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#gradeModal' + s.id + '"><i class="bi bi-pencil-square me-1"></i>Grade</button></td></tr>').join('') + '</tbody></table></div>' : '<div class="p-4 text-center text-muted"><i class="bi bi-inbox fs-1 d-block mb-3"></i><p>No submissions yet</p><small>Students will appear here when they submit their work</small></div>'}
      </div>
    </div>

    <!-- Not Submitted List -->
    ${expectedStudents && expectedStudents.length > 0 ? (function() {
      const submittedIds = (assignment.submissions || []).map(s => s.studentId);
      const notSubmitted = expectedStudents.filter(s => !submittedIds.includes(s.id));
      if (notSubmitted.length > 0) {
        return '<div class="card mt-4"><div class="card-header bg-white"><h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>Not Yet Submitted (' + notSubmitted.length + ')</h6></div><div class="card-body p-0"><ul class="list-group list-group-flush">' + notSubmitted.map(s => '<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>' + s.firstName + ' ' + s.lastName + '</strong><br><small class="text-muted">' + s.email + '</small></div><span class="badge bg-secondary">Pending</span></li>').join('') + '</ul></div></div>';
      }
      return '';
    })() : ''}
  </div>
</div>

<!-- Grade Modals -->
${assignment.submissions ? assignment.submissions.map(s => '<div class="modal fade" id="gradeModal' + s.id + '" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form action="' + (typeof basePath !== 'undefined' ? basePath : '') + '/teacher/assignments/' + assignment.id + '/grade/' + s.id + '" method="POST"><div class="modal-header"><h5 class="modal-title">Grade Submission</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p><strong>Student:</strong> ' + s.student.firstName + ' ' + s.student.lastName + '</p><p><strong>Submitted:</strong> ' + new Date(s.submittedAt).toLocaleString() + '</p>' + (s.content ? '<div class="mb-3"><label class="form-label">Student Response:</label><div class="p-3 bg-light rounded" style="white-space: pre-wrap;">' + s.content + '</div></div>' : '') + '<div class="mb-3"><label class="form-label">Grade (out of ' + assignment.maxPoints + ')</label><input type="number" name="grade" class="form-control" min="0" max="' + assignment.maxPoints + '" value="' + (s.grade || '') + '" required></div><div class="mb-3"><label class="form-label">Feedback</label><textarea name="feedback" class="form-control" rows="3" placeholder="Provide feedback to the student...">' + (s.feedback || '') + '</textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save Grade</button></div></form></div></div></div>').join('') : ''}

<!-- Delete Button -->
<div class="mt-4">
  <form action="${typeof basePath !== 'undefined' ? basePath : ''}/teacher/assignments/${assignment.id}/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this assignment? This will also delete all submissions.');">
    <button type="submit" class="btn btn-outline-danger btn-sm">
      <i class="bi bi-trash me-2"></i>Delete Assignment
    </button>
  </form>
</div>
`, activePage: 'assignments', pageTitle: assignment.title }) %>
