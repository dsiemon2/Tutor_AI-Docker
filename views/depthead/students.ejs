<%- include('../layouts/depthead', { body: `
<!-- Department Info -->
${category ? '<div class="alert alert-warning mb-4"><i class="bi bi-diagram-3 me-2"></i><strong>' + category.name + ' Department</strong> - Students</div>' : ''}

<!-- Students List -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-mortarboard me-2"></i>Students in Department Subjects</h5>
    <span class="badge bg-warning text-dark">${students ? students.length : 0} students</span>
  </div>
  <div class="card-body p-0">
    ${students && students.length > 0 ? '<div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Name</th><th>Grade</th><th>Classes</th><th>Sessions</th><th>Progress</th></tr></thead><tbody>' + students.map(s => {
      const deptClasses = s.classesAsStudent ? s.classesAsStudent.filter(cs => cs.class && cs.class.subject && cs.class.subject.categoryId === (category ? category.id : null)).map(cs => cs.class.name) : [];
      const sessionCount = s.tutoringSessionsAsStudent ? s.tutoringSessionsAsStudent.length : 0;
      const deptProgress = s.progress ? s.progress.filter(p => p.topic && p.topic.subject && p.topic.subject.category && p.topic.subject.category.id === (category ? category.id : null)) : [];
      const avgMastery = deptProgress.length > 0 ? Math.round(deptProgress.reduce((sum, p) => sum + p.masteryLevel, 0) / deptProgress.length) : 0;
      const progressColor = avgMastery >= 80 ? 'success' : avgMastery >= 60 ? 'primary' : avgMastery >= 40 ? 'warning' : 'danger';
      return '<tr><td><strong>' + s.firstName + ' ' + s.lastName + '</strong><br><small class="text-muted">' + s.email + '</small></td><td>' + (s.gradeLevel !== null ? (s.gradeLevel === 0 ? 'K' : s.gradeLevel < 0 ? 'Pre-K' : s.gradeLevel) : '-') + '</td><td>' + (deptClasses.length > 0 ? '<span class="badge bg-secondary">' + deptClasses.length + '</span><br><small class="text-muted">' + deptClasses.slice(0, 2).join(', ') + (deptClasses.length > 2 ? '...' : '') + '</small>' : '-') + '</td><td>' + sessionCount + '</td><td><div class="progress" style="width: 100px; height: 8px;"><div class="progress-bar bg-' + progressColor + '" style="width: ' + avgMastery + '%"></div></div><small class="text-muted">' + avgMastery + '% mastery</small></td></tr>';
    }).join('') + '</tbody></table></div>' : '<div class="p-5 text-center text-muted"><i class="bi bi-inbox fs-1 d-block mb-3"></i><p>No students in department subjects</p></div>'}
  </div>
</div>

<!-- Students by Grade Level -->
${students && students.length > 0 ? '<div class="card mt-4"><div class="card-header"><h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Students by Grade Level</h5></div><div class="card-body">' + (function() {
  const gradeGroups = {};
  students.forEach(s => {
    const grade = s.gradeLevel !== null ? (s.gradeLevel === 0 ? 'K' : s.gradeLevel < 0 ? 'Pre-K' : 'Grade ' + s.gradeLevel) : 'Unassigned';
    if (!gradeGroups[grade]) gradeGroups[grade] = 0;
    gradeGroups[grade]++;
  });
  const sortedGrades = Object.entries(gradeGroups).sort((a, b) => {
    const orderA = a[0] === 'Pre-K' ? -2 : a[0] === 'K' ? -1 : a[0] === 'Unassigned' ? 100 : parseInt(a[0].replace('Grade ', ''));
    const orderB = b[0] === 'Pre-K' ? -2 : b[0] === 'K' ? -1 : b[0] === 'Unassigned' ? 100 : parseInt(b[0].replace('Grade ', ''));
    return orderA - orderB;
  });
  return '<div class="d-flex flex-wrap gap-3">' + sortedGrades.map(([grade, count]) => '<div class="text-center p-3 bg-light rounded"><div class="fw-bold fs-4 text-warning">' + count + '</div><div class="text-muted">' + grade + '</div></div>').join('') + '</div>';
})() + '</div></div>' : ''}
`, activePage: 'students', pageTitle: 'Students' }) %>
