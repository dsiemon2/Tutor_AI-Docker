<%- include('../layouts/depthead', { body: `
<!-- Department Info -->
${category ? '<div class="alert alert-warning mb-4"><i class="bi bi-diagram-3 me-2"></i><strong>' + category.name + ' Department</strong> - Analytics</div>' : ''}

<!-- Session Stats -->
<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="stat-card">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stat-label">Total Sessions (30 days)</div>
          <div class="stat-value">${recentSessions ? recentSessions.length : 0}</div>
        </div>
        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
          <i class="bi bi-chat-dots"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stat-label">Avg Session Duration</div>
          <div class="stat-value">${recentSessions && recentSessions.length > 0 ? Math.round(recentSessions.filter(s => s.duration).reduce((sum, s) => sum + (s.duration || 0), 0) / recentSessions.filter(s => s.duration).length / 60) || 0 : 0} min</div>
        </div>
        <div class="stat-icon bg-success bg-opacity-10 text-success">
          <i class="bi bi-clock"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stat-label">Subjects Tracked</div>
          <div class="stat-value">${subjects ? subjects.length : 0}</div>
        </div>
        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
          <i class="bi bi-book"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sessions by Subject -->
<div class="row g-4">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Sessions by Subject</h5>
      </div>
      <div class="card-body">
        ${sessionsBySubject && sessionsBySubject.length > 0 ? '<div class="list-group list-group-flush">' + sessionsBySubject.map(ss => {
          const subject = subjects ? subjects.find(s => s.id === ss.subjectId) : null;
          const maxCount = Math.max(...sessionsBySubject.map(x => x._count.id));
          const percentage = maxCount > 0 ? Math.round((ss._count.id / maxCount) * 100) : 0;
          return '<div class="list-group-item d-flex justify-content-between align-items-center"><div><strong>' + (subject ? subject.name : 'Unknown') + '</strong><div class="progress mt-1" style="width: 200px; height: 6px;"><div class="progress-bar bg-warning" style="width: ' + percentage + '%"></div></div></div><span class="badge bg-warning text-dark">' + ss._count.id + ' sessions</span></div>';
        }).join('') + '</div>' : '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No session data</div>'}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Average Mastery by Subject</h5>
      </div>
      <div class="card-body">
        ${masteryBySubject && Object.keys(masteryBySubject).length > 0 ? '<div class="list-group list-group-flush">' + Object.entries(masteryBySubject).map(([subjectName, data]) => {
          const avg = data.count > 0 ? Math.round(data.total / data.count) : 0;
          const color = avg >= 80 ? 'success' : avg >= 60 ? 'primary' : avg >= 40 ? 'warning' : 'danger';
          return '<div class="list-group-item d-flex justify-content-between align-items-center"><div><strong>' + subjectName + '</strong><div class="progress mt-1" style="width: 200px; height: 6px;"><div class="progress-bar bg-' + color + '" style="width: ' + avg + '%"></div></div></div><span class="badge bg-' + color + '">' + avg + '%</span></div>';
        }).join('') + '</div>' : '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No mastery data</div>'}
      </div>
    </div>
  </div>
</div>

<!-- Session Trend -->
<div class="card mt-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Session Activity (Last 30 Days)</h5>
  </div>
  <div class="card-body">
    ${recentSessions && recentSessions.length > 0 ? (function() {
      const days = {};
      const now = new Date();
      for (let i = 29; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        days[key] = 0;
      }
      recentSessions.forEach(s => {
        const key = new Date(s.startedAt).toISOString().split('T')[0];
        if (days.hasOwnProperty(key)) days[key]++;
      });
      const maxCount = Math.max(...Object.values(days), 1);
      return '<div class="d-flex align-items-end gap-1" style="height: 150px;">' + Object.entries(days).map(([date, count]) => {
        const height = maxCount > 0 ? Math.max(5, (count / maxCount) * 100) : 5;
        return '<div class="flex-fill bg-warning rounded-top" style="height: ' + height + '%" title="' + date + ': ' + count + ' sessions"></div>';
      }).join('') + '</div><div class="d-flex justify-content-between mt-2 text-muted small"><span>30 days ago</span><span>Today</span></div>';
    })() : '<div class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No session data</div>'}
  </div>
</div>
`, activePage: 'analytics', pageTitle: 'Analytics' }) %>
