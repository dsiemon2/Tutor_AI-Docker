<%- include('../layouts/student', { body: `
<div class="mb-4">
  <h4 class="mb-1">Settings</h4>
  <p class="text-muted mb-0">Customize your learning experience</p>
</div>

<div class="row g-4">
  <!-- Profile Settings -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-person me-2"></i>Profile</h5>
      </div>
      <div class="card-body">
        <form id="profileForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">First Name</label>
              <input type="text" class="form-control" value="${user.firstName}" name="firstName" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-control" value="${user.lastName}" name="lastName" required>
            </div>
            <div class="col-12">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" value="${user.email}" disabled>
              <small class="text-muted">Contact support to change your email</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Grade Level</label>
              <select class="form-select" name="gradeLevel">
                ${[1,2,3,4,5,6,7,8,9,10,11,12,13].map(g => '<option value="' + g + '" ' + (user.gradeLevel === g ? 'selected' : '') + '>' + (g === 13 ? 'College' : g + (g === 1 ? 'st' : g === 2 ? 'nd' : g === 3 ? 'rd' : 'th') + ' Grade') + '</option>').join('')}
              </select>
            </div>
          </div>
          <button type="submit" class="btn btn-primary mt-3">
            <i class="bi bi-check-lg me-2"></i>Save Changes
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Learning Preferences -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Learning Preferences</h5>
      </div>
      <div class="card-body">
        <form id="preferencesForm">
          <div class="mb-3">
            <label class="form-label">Preferred Language</label>
            <select class="form-select" name="preferredLanguage">
              <option value="en" ${user.preferredLanguage === 'en' ? 'selected' : ''}>English</option>
              <option value="es" ${user.preferredLanguage === 'es' ? 'selected' : ''}>Spanish</option>
              <option value="fr" ${user.preferredLanguage === 'fr' ? 'selected' : ''}>French</option>
              <option value="de" ${user.preferredLanguage === 'de' ? 'selected' : ''}>German</option>
              <option value="zh" ${user.preferredLanguage === 'zh' ? 'selected' : ''}>Chinese</option>
              <option value="ja" ${user.preferredLanguage === 'ja' ? 'selected' : ''}>Japanese</option>
              <option value="ko" ${user.preferredLanguage === 'ko' ? 'selected' : ''}>Korean</option>
              <option value="hi" ${user.preferredLanguage === 'hi' ? 'selected' : ''}>Hindi</option>
              <option value="ar" ${user.preferredLanguage === 'ar' ? 'selected' : ''}>Arabic</option>
              <option value="pt" ${user.preferredLanguage === 'pt' ? 'selected' : ''}>Portuguese</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Tutor Voice</label>
            <select class="form-select" name="preferredVoice">
              <option value="alloy" ${user.preferredVoice === 'alloy' ? 'selected' : ''}>Alloy (Neutral)</option>
              <option value="echo" ${user.preferredVoice === 'echo' ? 'selected' : ''}>Echo (Male)</option>
              <option value="fable" ${user.preferredVoice === 'fable' ? 'selected' : ''}>Fable (British)</option>
              <option value="onyx" ${user.preferredVoice === 'onyx' ? 'selected' : ''}>Onyx (Deep Male)</option>
              <option value="nova" ${user.preferredVoice === 'nova' ? 'selected' : ''}>Nova (Female)</option>
              <option value="shimmer" ${user.preferredVoice === 'shimmer' ? 'selected' : ''}>Shimmer (Soft Female)</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-2"></i>Save Preferences
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Accessibility (WCAG 2.1 AA) -->
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header bg-primary bg-opacity-10">
        <h5 class="mb-0"><i class="bi bi-universal-access me-2"></i>Accessibility Settings</h5>
      </div>
      <div class="card-body">
        <form id="accessibilityForm">
          <div class="row">
            <!-- Visual Settings -->
            <div class="col-md-6">
              <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-eye me-2"></i>Visual</h6>

              <div class="mb-3">
                <label class="form-label" for="textSize">Text Size</label>
                <select class="form-select" id="textSize" name="textSize" aria-describedby="textSizeHelp">
                  <option value="small" ${user.textSize === 'small' ? 'selected' : ''}>Small (85%)</option>
                  <option value="normal" ${user.textSize === 'normal' || !user.textSize ? 'selected' : ''}>Normal (100%)</option>
                  <option value="large" ${user.textSize === 'large' ? 'selected' : ''}>Large (115%)</option>
                  <option value="x-large" ${user.textSize === 'x-large' ? 'selected' : ''}>Extra Large (130%)</option>
                </select>
                <small id="textSizeHelp" class="form-text text-muted">Adjust the text size across the platform</small>
              </div>

              <div class="mb-3">
                <label class="form-label" for="lineSpacing">Line Spacing</label>
                <select class="form-select" id="lineSpacing" name="lineSpacing">
                  <option value="normal" ${!user.lineSpacing || user.lineSpacing === 'normal' ? 'selected' : ''}>Normal</option>
                  <option value="wide" ${user.lineSpacing === 'wide' ? 'selected' : ''}>Wide (1.8x)</option>
                  <option value="extra-wide" ${user.lineSpacing === 'extra-wide' ? 'selected' : ''}>Extra Wide (2.2x)</option>
                </select>
              </div>

              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="highContrast" name="highContrast" ${user.highContrast ? 'checked' : ''} role="switch" aria-describedby="highContrastHelp">
                <label class="form-check-label" for="highContrast">High Contrast Mode</label>
                <div id="highContrastHelp" class="form-text">Enhanced color contrast for better visibility</div>
              </div>

              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="dyslexiaFont" name="dyslexiaFont" ${user.dyslexiaFont ? 'checked' : ''} role="switch" aria-describedby="dyslexiaFontHelp">
                <label class="form-check-label" for="dyslexiaFont">Dyslexia-Friendly Font</label>
                <div id="dyslexiaFontHelp" class="form-text">Use OpenDyslexic font for easier reading</div>
              </div>

              <div class="mb-3">
                <label class="form-label" for="colorBlindMode">Color Blind Mode</label>
                <select class="form-select" id="colorBlindMode" name="colorBlindMode">
                  <option value="none" ${!user.colorBlindMode || user.colorBlindMode === 'none' ? 'selected' : ''}>None</option>
                  <option value="protanopia" ${user.colorBlindMode === 'protanopia' ? 'selected' : ''}>Protanopia (Red-Blind)</option>
                  <option value="deuteranopia" ${user.colorBlindMode === 'deuteranopia' ? 'selected' : ''}>Deuteranopia (Green-Blind)</option>
                  <option value="tritanopia" ${user.colorBlindMode === 'tritanopia' ? 'selected' : ''}>Tritanopia (Blue-Blind)</option>
                </select>
              </div>
            </div>

            <!-- Motion & Interaction -->
            <div class="col-md-6">
              <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-keyboard me-2"></i>Motion & Interaction</h6>

              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="reducedMotion" name="reducedMotion" ${user.reducedMotion ? 'checked' : ''} role="switch" aria-describedby="reducedMotionHelp">
                <label class="form-check-label" for="reducedMotion">Reduce Motion</label>
                <div id="reducedMotionHelp" class="form-text">Minimize animations and transitions</div>
              </div>

              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="focusHighlight" name="focusHighlight" ${user.focusHighlight !== false ? 'checked' : ''} role="switch" aria-describedby="focusHighlightHelp">
                <label class="form-check-label" for="focusHighlight">Enhanced Focus Indicators</label>
                <div id="focusHighlightHelp" class="form-text">Show prominent focus outlines for keyboard navigation</div>
              </div>

              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="screenReaderMode" name="screenReaderMode" ${user.screenReaderMode ? 'checked' : ''} role="switch" aria-describedby="screenReaderHelp">
                <label class="form-check-label" for="screenReaderMode">Screen Reader Optimizations</label>
                <div id="screenReaderHelp" class="form-text">Enhanced announcements for screen readers</div>
              </div>

              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="autoplayMedia" name="autoplayMedia" ${user.autoplayMedia !== false ? 'checked' : ''} role="switch">
                <label class="form-check-label" for="autoplayMedia">Autoplay Media</label>
              </div>

              <div class="mb-3">
                <label class="form-label" for="cursorSize">Cursor Size</label>
                <select class="form-select" id="cursorSize" name="cursorSize">
                  <option value="normal" ${!user.cursorSize || user.cursorSize === 'normal' ? 'selected' : ''}>Normal</option>
                  <option value="large" ${user.cursorSize === 'large' ? 'selected' : ''}>Large</option>
                </select>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-outline-secondary" onclick="resetAccessibilityDefaults()">
              <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Defaults
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-2"></i>Save Accessibility Settings
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Account Actions -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Account</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
            <i class="bi bi-key me-2"></i>Change Password
          </button>
          <a href="${typeof basePath !== 'undefined' ? basePath : ''}/auth/logout" class="btn btn-outline-danger">
            <i class="bi bi-box-arrow-right me-2"></i>Sign Out
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Privacy (GDPR) -->
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header bg-info bg-opacity-10">
        <h5 class="mb-0"><i class="bi bi-file-earmark-lock me-2"></i>Data Privacy</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6><i class="bi bi-download me-2"></i>Export Your Data</h6>
            <p class="text-muted small">Download a copy of all your data including profile, learning sessions, progress, quizzes, assignments, and messages.</p>
            <button id="exportDataBtn" class="btn btn-outline-primary">
              <i class="bi bi-download me-2"></i>Download My Data
            </button>
          </div>
          <div class="col-md-6">
            <h6><i class="bi bi-trash me-2"></i>Delete Your Account</h6>
            <p class="text-muted small">Request permanent deletion of your account and all associated data. You have 30 days to cancel after requesting.</p>
            <div id="deletionStatus">
              <!-- Status loaded via JavaScript -->
            </div>
            <button id="requestDeletionBtn" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deletionModal">
              <i class="bi bi-trash me-2"></i>Request Account Deletion
            </button>
            <button id="cancelDeletionBtn" class="btn btn-outline-success d-none">
              <i class="bi bi-x-circle me-2"></i>Cancel Deletion Request
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="passwordForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Current Password</label>
            <input type="password" class="form-control" name="currentPassword" required>
          </div>
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <input type="password" class="form-control" name="newPassword" minlength="8" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input type="password" class="form-control" name="confirmPassword" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Account Deletion Modal -->
<div class="modal fade" id="deletionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Request Account Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="deletionForm">
        <div class="modal-body">
          <div class="alert alert-warning">
            <strong>Warning:</strong> This action will permanently delete your account and all associated data after 30 days.
          </div>
          <p>Please note that deleting your account will remove:</p>
          <ul>
            <li>Your profile and settings</li>
            <li>All tutoring session history</li>
            <li>Learning progress and achievements</li>
            <li>Quiz attempts and scores</li>
            <li>Assignment submissions</li>
            <li>Messages and notifications</li>
          </ul>
          <div class="mb-3">
            <label class="form-label">Reason for leaving (optional)</label>
            <textarea class="form-control" name="reason" rows="3" placeholder="Help us improve by telling us why you're leaving..."></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="confirmDeletion" required>
            <label class="form-check-label" for="confirmDeletion">
              I understand that my data will be permanently deleted after 30 days and this cannot be undone.
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Request Deletion</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const basePath = '${typeof basePath !== "undefined" ? basePath : ""}';

  // Handle form submissions
  document.getElementById('preferencesForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch(basePath + '/api/user/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert('Preferences saved successfully!');
      } else {
        alert('Failed to save preferences');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred');
    }
  });

  document.getElementById('accessibilityForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
      textSize: e.target.textSize.value,
      lineSpacing: e.target.lineSpacing.value,
      highContrast: e.target.highContrast.checked,
      dyslexiaFont: e.target.dyslexiaFont.checked,
      colorBlindMode: e.target.colorBlindMode.value,
      reducedMotion: e.target.reducedMotion.checked,
      focusHighlight: e.target.focusHighlight.checked,
      screenReaderMode: e.target.screenReaderMode.checked,
      autoplayMedia: e.target.autoplayMedia.checked,
      cursorSize: e.target.cursorSize.value
    };

    try {
      const response = await fetch(basePath + '/api/user/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        // Announce to screen readers
        if (window.announceToScreenReader) {
          window.announceToScreenReader('Accessibility settings saved successfully');
        }
        alert('Accessibility settings saved! The page will reload to apply changes.');
        location.reload();
      } else {
        alert('Failed to save settings');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred');
    }
  });

  function resetAccessibilityDefaults() {
    if (!confirm('Reset all accessibility settings to defaults?')) return;

    document.getElementById('textSize').value = 'normal';
    document.getElementById('lineSpacing').value = 'normal';
    document.getElementById('highContrast').checked = false;
    document.getElementById('dyslexiaFont').checked = false;
    document.getElementById('colorBlindMode').value = 'none';
    document.getElementById('reducedMotion').checked = false;
    document.getElementById('focusHighlight').checked = true;
    document.getElementById('screenReaderMode').checked = false;
    document.getElementById('autoplayMedia').checked = true;
    document.getElementById('cursorSize').value = 'normal';

    alert('Settings reset to defaults. Click "Save" to apply.');
  }

  // ==========================================
  // GDPR / Data Privacy Functions
  // ==========================================

  // Check deletion status on page load
  async function checkDeletionStatus() {
    try {
      const response = await fetch(basePath + '/student/privacy/status');
      const status = await response.json();

      const statusDiv = document.getElementById('deletionStatus');
      const requestBtn = document.getElementById('requestDeletionBtn');
      const cancelBtn = document.getElementById('cancelDeletionBtn');

      if (status.hasPendingDeletion) {
        const scheduledDate = status.scheduledDate ? new Date(status.scheduledDate).toLocaleDateString() : 'Unknown';
        statusDiv.innerHTML = '<div class="alert alert-warning mb-2"><strong>Deletion Scheduled:</strong> Your account will be deleted on ' + scheduledDate + '</div>';
        requestBtn.classList.add('d-none');
        cancelBtn.classList.remove('d-none');
      } else {
        statusDiv.innerHTML = '';
        requestBtn.classList.remove('d-none');
        cancelBtn.classList.add('d-none');
      }
    } catch (error) {
      console.error('Error checking deletion status:', error);
    }
  }

  // Export data
  document.getElementById('exportDataBtn').addEventListener('click', async () => {
    const btn = document.getElementById('exportDataBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Preparing...';

    try {
      const response = await fetch(basePath + '/student/privacy/export');

      if (response.ok) {
        const data = await response.json();
        // Create download link
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tutorai-data-export-' + new Date().toISOString().split('T')[0] + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('Your data has been downloaded!');
      } else {
        const error = await response.json();
        alert('Failed to export data: ' + (error.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Export error:', error);
      alert('An error occurred while exporting your data');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-download me-2"></i>Download My Data';
    }
  });

  // Request deletion
  document.getElementById('deletionForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const reason = e.target.reason.value;

    try {
      const response = await fetch(basePath + '/student/privacy/delete-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      });

      const result = await response.json();

      if (response.ok) {
        alert(result.message);
        bootstrap.Modal.getInstance(document.getElementById('deletionModal')).hide();
        checkDeletionStatus();
      } else {
        alert('Failed to request deletion: ' + (result.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Deletion request error:', error);
      alert('An error occurred');
    }
  });

  // Cancel deletion
  document.getElementById('cancelDeletionBtn').addEventListener('click', async () => {
    if (!confirm('Are you sure you want to cancel your account deletion request?')) {
      return;
    }

    try {
      const response = await fetch(basePath + '/student/privacy/cancel-deletion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await response.json();

      if (response.ok) {
        alert(result.message);
        checkDeletionStatus();
      } else {
        alert('Failed to cancel deletion: ' + (result.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Cancel deletion error:', error);
      alert('An error occurred');
    }
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', checkDeletionStatus);
</script>
`, activePage: 'settings', pageTitle: 'Settings' }) %>
