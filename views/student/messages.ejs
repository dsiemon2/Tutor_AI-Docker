<%- include('../layouts/student', { body: `
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="mb-1"><i class="bi bi-chat-dots text-primary me-2"></i>Messages</h4>
    <p class="text-muted mb-0">Communicate with your teachers</p>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMessageModal">
    <i class="bi bi-pencil me-2"></i>New Message
  </button>
</div>

<div class="row g-4">
  <!-- Conversations List -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header bg-white">
        <h6 class="mb-0">Conversations</h6>
      </div>
      <div class="list-group list-group-flush" id="conversationsList" style="max-height: 500px; overflow-y: auto;">
        ${conversations && conversations.length > 0 ? conversations.map(conv => '<a href="#" class="list-group-item list-group-item-action d-flex align-items-center conversation-item" data-user-id="' + conv.partnerId + '"><div class="flex-shrink-0"><div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">' + (conv.partner ? conv.partner.firstName[0] + conv.partner.lastName[0] : '??') + '</div></div><div class="flex-grow-1 ms-3"><div class="d-flex justify-content-between"><strong>' + (conv.partner ? conv.partner.firstName + ' ' + conv.partner.lastName : 'Unknown') + '</strong>' + (conv.unreadCount > 0 ? '<span class="badge bg-danger rounded-pill">' + conv.unreadCount + '</span>' : '') + '</div><small class="text-muted text-truncate d-block">' + (conv.lastMessage ? (conv.lastMessage.content.length > 40 ? conv.lastMessage.content.substring(0, 40) + '...' : conv.lastMessage.content) : 'No messages') + '</small></div></a>').join('') : '<div class="text-center py-4 text-muted"><i class="bi bi-chat fs-1 d-block mb-2"></i>No conversations yet</div>'}
      </div>
    </div>
  </div>

  <!-- Message Thread -->
  <div class="col-md-8">
    <div class="card h-100">
      <div class="card-header bg-white d-flex justify-content-between align-items-center" id="chatHeader">
        <h6 class="mb-0">Select a conversation</h6>
      </div>
      <div class="card-body" id="messagesContainer" style="height: 400px; overflow-y: auto; background: #f8f9fa;">
        <div class="text-center text-muted py-5">
          <i class="bi bi-chat-dots fs-1 d-block mb-3"></i>
          Select a conversation to view messages
        </div>
      </div>
      <div class="card-footer bg-white d-none" id="messageInputArea">
        <form id="sendMessageForm" class="d-flex gap-2">
          <input type="hidden" id="receiverId" value="">
          <input type="text" id="messageContent" class="form-control" placeholder="Type a message..." required>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-send"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>New Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="newMessageForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">To (Teacher)</label>
            <select id="newRecipient" class="form-select" required>
              <option value="">Select a teacher...</option>
              ${teachers && teachers.map(t => '<option value="' + t.id + '">' + t.firstName + ' ' + t.lastName + '</option>').join('')}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Subject (optional)</label>
            <input type="text" id="newSubject" class="form-control" placeholder="Message subject">
          </div>
          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea id="newContent" class="form-control" rows="4" placeholder="Type your message..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Message</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const basePath = '${typeof basePath !== 'undefined' ? basePath : ''}';
  const currentUserId = '${user?.id || ''}';
  let selectedUserId = null;

  // Load messages for a conversation
  async function loadMessages(userId) {
    selectedUserId = userId;
    document.getElementById('receiverId').value = userId;
    document.getElementById('messageInputArea').classList.remove('d-none');

    try {
      const response = await fetch(basePath + '/api/messages/' + userId);
      const data = await response.json();

      if (data.success) {
        const container = document.getElementById('messagesContainer');
        const partner = document.querySelector('[data-user-id="' + userId + '"]');
        const partnerName = partner ? partner.querySelector('strong').textContent : 'User';

        document.getElementById('chatHeader').innerHTML = '<h6 class="mb-0"><i class="bi bi-person-circle me-2"></i>' + partnerName + '</h6>';

        if (data.messages.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-5">No messages yet. Start the conversation!</div>';
        } else {
          container.innerHTML = data.messages.map(msg => '<div class="mb-3 ' + (msg.senderId === currentUserId ? 'text-end' : '') + '"><div class="d-inline-block p-3 rounded-3 ' + (msg.senderId === currentUserId ? 'bg-primary text-white' : 'bg-white border') + '" style="max-width: 80%;"><div>' + msg.content + '</div><small class="' + (msg.senderId === currentUserId ? 'text-white-50' : 'text-muted') + '">' + new Date(msg.createdAt).toLocaleString() + '</small></div></div>').join('');
          container.scrollTop = container.scrollHeight;
        }

        // Remove unread badge
        const badge = partner?.querySelector('.badge');
        if (badge) badge.remove();
      }
    } catch (error) {
      console.error('Failed to load messages:', error);
    }
  }

  // Send message
  document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const content = document.getElementById('messageContent').value.trim();
    if (!content || !selectedUserId) return;

    try {
      const response = await fetch(basePath + '/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receiverId: selectedUserId, content })
      });
      const data = await response.json();

      if (data.success) {
        document.getElementById('messageContent').value = '';
        loadMessages(selectedUserId);
      }
    } catch (error) {
      console.error('Failed to send message:', error);
    }
  });

  // New message form
  document.getElementById('newMessageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const receiverId = document.getElementById('newRecipient').value;
    const subject = document.getElementById('newSubject').value.trim();
    const content = document.getElementById('newContent').value.trim();

    if (!receiverId || !content) return;

    try {
      const response = await fetch(basePath + '/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receiverId, subject, content })
      });
      const data = await response.json();

      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('newMessageModal')).hide();
        location.reload();
      }
    } catch (error) {
      console.error('Failed to send message:', error);
    }
  });

  // Conversation click handlers
  document.querySelectorAll('.conversation-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
      this.classList.add('active');
      loadMessages(this.dataset.userId);
    });
  });
</script>
`, activePage: 'messages', pageTitle: 'Messages', branding, user }) %>
