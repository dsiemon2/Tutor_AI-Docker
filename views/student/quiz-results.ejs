<%- include('../layouts/student', { body: `
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/quizzes">Quizzes</a></li>
    <li class="breadcrumb-item"><a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/quizzes/${quiz.id}">${quiz.title}</a></li>
    <li class="breadcrumb-item active">Results</li>
  </ol>
</nav>

<!-- Results Summary -->
<div class="card mb-4 ${attempt.passed ? 'border-success' : 'border-danger'}">
  <div class="card-body text-center py-5">
    <div class="mb-3">
      ${attempt.passed ? '<i class="bi bi-trophy-fill text-success" style="font-size: 4rem;"></i>' : '<i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>'}
    </div>
    <h2 class="${attempt.passed ? 'text-success' : 'text-danger'}">${attempt.passed ? 'Congratulations!' : 'Keep Practicing!'}</h2>
    <p class="text-muted mb-4">${attempt.passed ? 'You passed the quiz!' : 'You did not reach the passing score of ' + quiz.passingScore + '%.'}</p>

    <div class="row justify-content-center g-4 mb-4">
      <div class="col-md-3">
        <div class="p-3 bg-light rounded">
          <div class="fs-1 fw-bold ${attempt.passed ? 'text-success' : 'text-danger'}">${Math.round(attempt.percentage)}%</div>
          <small class="text-muted">Your Score</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="p-3 bg-light rounded">
          <div class="fs-1 fw-bold text-primary">${attempt.score}/${quiz.questions.reduce((sum, q) => sum + q.points, 0)}</div>
          <small class="text-muted">Points Earned</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="p-3 bg-light rounded">
          <div class="fs-1 fw-bold text-info">${attempt.answers?.filter(a => a.isCorrect).length || 0}/${quiz.questions.length}</div>
          <small class="text-muted">Correct</small>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-center gap-2">
      <a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/quizzes/${quiz.id}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left me-1"></i>Back to Quiz
      </a>
      <a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/quizzes" class="btn btn-primary">
        <i class="bi bi-list me-1"></i>All Quizzes
      </a>
    </div>
  </div>
</div>

<!-- Question Review -->
${quiz.showAnswers ? '<div class="card"><div class="card-header bg-white"><h6 class="mb-0"><i class="bi bi-list-check me-2"></i>Question Review</h6></div><div class="card-body p-0"><div class="list-group list-group-flush">' + quiz.questions.map((q, i) => {
  const answer = attempt.answers?.find(a => a.questionId === q.id);
  let options = [];
  let matchingPairs = [];
  let orderingItems = [];
  try {
    if (q.options) {
      const parsed = JSON.parse(q.options);
      if (q.questionType === 'matching' && parsed.pairs) {
        matchingPairs = parsed.pairs;
      } else if (q.questionType === 'ordering' && parsed.items) {
        orderingItems = parsed.items;
      } else if (Array.isArray(parsed)) {
        options = parsed;
      }
    }
  } catch(e) { options = []; }

  const isCorrect = answer?.isCorrect;
  const isPendingReview = answer?.isCorrect === null;

  // Parse student answers for matching/ordering
  let studentMatchingAnswers = {};
  let studentOrderingAnswer = [];
  try {
    if (answer?.answer && q.questionType === 'matching') {
      studentMatchingAnswers = JSON.parse(answer.answer);
    } else if (answer?.answer && q.questionType === 'ordering') {
      studentOrderingAnswer = JSON.parse(answer.answer);
    }
  } catch(e) {}

  return '<div class="list-group-item"><div class="d-flex justify-content-between align-items-start mb-2"><div><strong>Q' + (i + 1) + '.</strong> ' + q.questionText + '</div><span class="badge ' + (isPendingReview ? 'bg-warning text-dark' : (isCorrect ? 'bg-success' : 'bg-danger')) + '">' + (isPendingReview ? 'Pending Review' : (isCorrect ? '+' + (answer?.pointsEarned || q.points) : '0')) + ' pt' + (q.points !== 1 ? 's' : '') + '</span></div>' +
    (q.questionType === 'multiple_choice' || q.questionType === 'true_false' ?
      '<div class="ms-3">' + options.map(opt => '<div class="py-1 ' + (opt === q.correctAnswer ? 'text-success fw-bold' : (opt === answer?.answer && !isCorrect ? 'text-danger text-decoration-line-through' : 'text-muted')) + '">' + (opt === q.correctAnswer ? '<i class="bi bi-check-circle-fill me-1"></i>' : (opt === answer?.answer && !isCorrect ? '<i class="bi bi-x-circle-fill me-1"></i>' : '<i class="bi bi-circle me-1"></i>')) + opt + '</div>').join('') + '</div>' :
    q.questionType === 'essay' ?
      '<div class="ms-3"><div class="mb-2"><strong>Your response:</strong></div><div class="p-3 bg-light rounded mb-2" style="white-space: pre-wrap;">' + (answer?.answer || '<em>No answer provided</em>') + '</div>' + (isPendingReview ? '<div class="alert alert-warning py-2 mb-0"><i class="bi bi-hourglass-split me-1"></i>This essay is pending manual review by your teacher.</div>' : (answer?.pointsEarned !== null ? '<div class="alert alert-info py-2 mb-0"><i class="bi bi-check-circle me-1"></i>Graded: ' + answer.pointsEarned + '/' + q.points + ' points</div>' : '')) + '</div>' :
    q.questionType === 'matching' ?
      '<div class="ms-3"><div class="row"><div class="col-md-6"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Item</th><th>Your Match</th><th>Correct Match</th></tr></thead><tbody>' + matchingPairs.map(pair => {
        const studentMatch = studentMatchingAnswers[pair.left] || '<em>Not matched</em>';
        const isMatchCorrect = studentMatchingAnswers[pair.left] === pair.right;
        return '<tr><td>' + pair.left + '</td><td class="' + (isMatchCorrect ? 'text-success' : 'text-danger') + '">' + (isMatchCorrect ? '<i class="bi bi-check-circle me-1"></i>' : '<i class="bi bi-x-circle me-1"></i>') + studentMatch + '</td><td class="text-success">' + pair.right + '</td></tr>';
      }).join('') + '</tbody></table></div></div></div>' :
    q.questionType === 'ordering' ?
      '<div class="ms-3"><div class="row"><div class="col-md-6"><h6 class="text-muted">Your Order</h6><ol class="mb-3">' + studentOrderingAnswer.map((item, idx) => {
        const isInCorrectPosition = orderingItems[idx] === item;
        return '<li class="' + (isInCorrectPosition ? 'text-success' : 'text-danger') + '">' + (isInCorrectPosition ? '<i class="bi bi-check-circle me-1"></i>' : '<i class="bi bi-x-circle me-1"></i>') + item + '</li>';
      }).join('') + '</ol></div><div class="col-md-6"><h6 class="text-muted">Correct Order</h6><ol class="text-success">' + orderingItems.map(item => '<li>' + item + '</li>').join('') + '</ol></div></div></div>' :
      '<div class="ms-3"><div class="mb-1"><strong>Your answer:</strong> <span class="' + (isCorrect ? 'text-success' : 'text-danger') + '">' + (answer?.answer || '<em>No answer</em>') + '</span></div><div><strong>Correct answer:</strong> <span class="text-success">' + q.correctAnswer + '</span></div></div>'
    ) +
    (q.explanation ? '<div class="alert alert-info py-2 mt-2 mb-0"><i class="bi bi-lightbulb me-1"></i>' + q.explanation + '</div>' : '') +
  '</div>';
}).join('') + '</div></div></div>' : '<div class="card"><div class="card-body text-center py-4 text-muted"><i class="bi bi-eye-slash fs-1 d-block mb-2"></i><p class="mb-0">Answer review is not available for this quiz.</p></div></div>'}
`, activePage: 'quizzes', pageTitle: 'Quiz Results', branding, user }) %>
