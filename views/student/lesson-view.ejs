<%- include('../layouts/student', { body: `
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/subjects">Subjects</a></li>
    <li class="breadcrumb-item"><a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/topics/${lesson.topicId}">${lesson.topic?.name || 'Topic'}</a></li>
    <li class="breadcrumb-item active">${lesson.title}</li>
  </ol>
</nav>

<div class="row g-4">
  <!-- Main Content -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-1">${lesson.title}</h4>
            <small class="text-muted">
              ${lesson.topic?.subject?.name || 'Subject'} - ${lesson.topic?.name || 'Topic'}
              ${lesson.duration ? ' | <i class="bi bi-clock"></i> ' + lesson.duration + ' minutes' : ''}
            </small>
          </div>
          <a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/tutor?topicId=${lesson.topicId}" class="btn btn-primary">
            <i class="bi bi-chat-dots me-2"></i>Ask Questions
          </a>
        </div>
      </div>
      <div class="card-body">
        ${lesson.description ? '<p class="lead text-muted mb-4">' + lesson.description + '</p><hr>' : ''}
        <div class="lesson-content" style="font-size: 1.05rem; line-height: 1.7;">
          ${lesson.content || '<p class="text-muted">No content available.</p>'}
        </div>
      </div>
    </div>

    <!-- Related Assignment -->
    ${relatedAssignment ? '<div class="card mt-4 border-primary"><div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Related Assignment</h6></div><div class="card-body"><h5>' + relatedAssignment.title + '</h5><p class="text-muted">' + relatedAssignment.type + ' | ' + relatedAssignment.maxPoints + ' points' + (relatedAssignment.dueDate ? ' | Due: ' + new Date(relatedAssignment.dueDate).toLocaleDateString() : '') + '</p><a href="' + (typeof basePath !== 'undefined' ? basePath : '') + '/student/assignments/' + relatedAssignment.id + '" class="btn btn-primary"><i class="bi bi-arrow-right me-2"></i>View Assignment</a></div></div>' : ''}
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Navigation -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-list-ol me-2"></i>Lessons in This Topic</h6>
      </div>
      <div class="list-group list-group-flush">
        ${topicLessons ? topicLessons.map((l, i) => '<a href="' + (typeof basePath !== 'undefined' ? basePath : '') + '/student/lessons/' + l.id + '" class="list-group-item list-group-item-action d-flex align-items-center gap-2 ' + (l.id === lesson.id ? 'active' : '') + '"><span class="badge ' + (l.id === lesson.id ? 'bg-white text-primary' : 'bg-primary') + ' rounded-pill">' + (i + 1) + '</span>' + l.title + '</a>').join('') : '<div class="list-group-item text-muted">No other lessons</div>'}
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Actions</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/tutor?topicId=${lesson.topicId}" class="btn btn-primary">
            <i class="bi bi-chat-dots me-2"></i>Ask AI About This Lesson
          </a>
          <a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/topics/${lesson.topicId}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Topic
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .lesson-content h1, .lesson-content h2, .lesson-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }
  .lesson-content h1 { font-size: 1.75rem; }
  .lesson-content h2 { font-size: 1.5rem; }
  .lesson-content h3 { font-size: 1.25rem; }
  .lesson-content ul, .lesson-content ol {
    margin-bottom: 1rem;
  }
  .lesson-content li {
    margin-bottom: 0.5rem;
  }
  .lesson-content table {
    width: 100%;
    margin-bottom: 1rem;
    border-collapse: collapse;
  }
  .lesson-content th, .lesson-content td {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
  }
  .lesson-content th {
    background: #f8f9fa;
  }
  .lesson-content code {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
  }
  .lesson-content pre {
    background: #1e293b;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
  }
  .lesson-content blockquote {
    border-left: 4px solid var(--primary-color);
    padding-left: 1rem;
    margin-left: 0;
    color: #64748b;
  }
</style>

<!-- Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const content = document.querySelector('.lesson-content');
    if (content && typeof marked !== 'undefined') {
      // Render markdown
      content.innerHTML = marked.parse(content.innerHTML);

      // Render math with KaTeX
      if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(content, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
          ]
        });
      }
    }
  });
</script>
`, activePage: 'subjects', pageTitle: lesson.title, branding, user }) %>
