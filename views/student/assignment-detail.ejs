<%- include('../layouts/student', { body: `
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="${typeof basePath !== 'undefined' ? basePath : ''}/student/assignments">Assignments</a></li>
    <li class="breadcrumb-item active">${assignment.title}</li>
  </ol>
</nav>

<div class="row g-4">
  <!-- Assignment Details -->
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">${assignment.title}</h5>
        <span class="badge ${mySubmission ? (mySubmission.status === 'graded' ? 'bg-success' : 'bg-info') : (assignment.dueDate && new Date(assignment.dueDate) < new Date() ? 'bg-danger' : 'bg-warning text-dark')}">${mySubmission ? (mySubmission.status === 'graded' ? 'Graded' : 'Submitted') : (assignment.dueDate && new Date(assignment.dueDate) < new Date() ? 'Overdue' : 'Pending')}</span>
      </div>
      <div class="card-body">
        <div class="d-flex gap-2 flex-wrap mb-3">
          <span class="badge bg-secondary">${assignment.type}</span>
          <span class="badge bg-primary">${assignment.maxPoints} points max</span>
          ${assignment.allowLate ? '<span class="badge bg-success">Late OK</span>' : '<span class="badge bg-warning text-dark">No late</span>'}
        </div>

        <p class="text-muted mb-3">
          <strong>Subject:</strong> ${assignment.topic?.subject?.name || 'N/A'} - ${assignment.topic?.name || 'N/A'}
          ${assignment.lesson ? '<br><strong>Related Lesson:</strong> ' + assignment.lesson.title : ''}
        </p>

        <hr>

        <h6><i class="bi bi-list-task me-2"></i>Instructions</h6>
        <div class="p-3 bg-light rounded" style="white-space: pre-wrap;">${assignment.instructions}</div>
      </div>
    </div>

    <!-- Submission Form -->
    ${!mySubmission || mySubmission.status !== 'graded' ? `
    <div class="card">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-upload me-2"></i>${mySubmission ? 'Update Your Submission' : 'Submit Your Work'}</h6>
      </div>
      <div class="card-body">
        <form action="${typeof basePath !== 'undefined' ? basePath : ''}/student/assignments/${assignment.id}/submit" method="POST" id="submissionForm">
          <div class="mb-3">
            <label class="form-label">Your Response</label>
            <textarea name="content" class="form-control" rows="8" placeholder="Enter your work here...">${mySubmission?.content || ''}</textarea>
            <small class="text-muted">You can update your submission until it has been graded.</small>
          </div>

          <!-- File Upload Section -->
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-paperclip me-1"></i>Attachments</label>
            <div class="border rounded p-3 bg-light">
              <input type="file" id="fileInput" class="d-none" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple>
              <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-cloud-upload me-2"></i>Choose Files
              </button>
              <small class="text-muted ms-2">PDF, Word, Images (max 10MB each)</small>

              <div id="uploadedFiles" class="mt-3">
                <!-- Previously uploaded files will appear here -->
                ${mySubmission?.attachments ? (function() {
                  try {
                    const attachments = JSON.parse(mySubmission.attachments);
                    if (Array.isArray(attachments) && attachments.length > 0) {
                      return '<div class="small text-muted mb-2">Previously uploaded files:</div>' +
                        attachments.map((id, i) => '<div class="d-flex align-items-center gap-2 mb-1 p-2 bg-white rounded border"><i class="bi bi-file-earmark text-primary"></i><span>Attachment ' + (i+1) + '</span><input type="hidden" name="attachments[]" value="' + id + '"></div>').join('');
                    }
                    return '';
                  } catch { return ''; }
                })() : ''}
              </div>

              <div id="uploadProgress" class="mt-2 d-none">
                <div class="progress" style="height: 4px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <input type="hidden" name="attachments" id="attachmentsInput" value="${mySubmission?.attachments || '[]'}">

          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-check-lg me-2"></i>${mySubmission ? 'Update Submission' : 'Submit Assignment'}
          </button>
        </form>
      </div>
    </div>

    <script>
      const uploadedFileIds = ${mySubmission?.attachments || '[]'};
      const basePath = '${typeof basePath !== 'undefined' ? basePath : ''}';

      document.getElementById('fileInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = uploadProgress.querySelector('.progress-bar');
        const uploadedFilesDiv = document.getElementById('uploadedFiles');
        const submitBtn = document.getElementById('submitBtn');

        for (let i = 0; i < files.length; i++) {
          const file = files[i];

          // Check file size (10MB max)
          if (file.size > 10 * 1024 * 1024) {
            alert('File ' + file.name + ' is too large. Maximum size is 10MB.');
            continue;
          }

          uploadProgress.classList.remove('d-none');
          submitBtn.disabled = true;
          progressBar.style.width = '0%';

          const formData = new FormData();
          formData.append('file', file);

          try {
            const response = await fetch(basePath + '/api/uploads', {
              method: 'POST',
              body: formData
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success && result.upload) {
                uploadedFileIds.push(result.upload.id);

                // Add file to display
                const fileDiv = document.createElement('div');
                fileDiv.className = 'd-flex align-items-center gap-2 mb-1 p-2 bg-white rounded border';
                fileDiv.innerHTML = '<i class="bi bi-file-earmark-check text-success"></i><span>' + file.name + '</span><button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="removeFile(this, \\'' + result.upload.id + '\\')"><i class="bi bi-x"></i></button><input type="hidden" name="attachments[]" value="' + result.upload.id + '">';
                uploadedFilesDiv.appendChild(fileDiv);
              }
            } else {
              alert('Failed to upload ' + file.name);
            }
          } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload ' + file.name);
          }

          progressBar.style.width = ((i + 1) / files.length * 100) + '%';
        }

        // Update hidden input
        document.getElementById('attachmentsInput').value = JSON.stringify(uploadedFileIds);

        uploadProgress.classList.add('d-none');
        submitBtn.disabled = false;
        e.target.value = ''; // Reset file input
      });

      function removeFile(btn, fileId) {
        const index = uploadedFileIds.indexOf(fileId);
        if (index > -1) {
          uploadedFileIds.splice(index, 1);
          document.getElementById('attachmentsInput').value = JSON.stringify(uploadedFileIds);
        }
        btn.closest('.d-flex').remove();
      }
    </script>
    ` : ''}

    <!-- Submitted Work (if graded) -->
    ${mySubmission && mySubmission.status === 'graded' ? `
    <div class="card">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-file-text me-2"></i>Your Submission</h6>
      </div>
      <div class="card-body">
        ${mySubmission.content ? '<div class="p-3 bg-light rounded mb-3" style="white-space: pre-wrap;">' + mySubmission.content + '</div>' : ''}
        ${mySubmission.attachments ? (function() {
          try {
            const attachments = JSON.parse(mySubmission.attachments);
            if (Array.isArray(attachments) && attachments.length > 0) {
              return '<div class="border-top pt-3"><h6 class="text-muted small mb-2">Attachments</h6>' +
                attachments.map((id, i) => '<a href="' + (typeof basePath !== 'undefined' ? basePath : '') + '/api/uploads/' + id + '" class="btn btn-sm btn-outline-primary me-2 mb-2" target="_blank"><i class="bi bi-file-earmark me-1"></i>Attachment ' + (i+1) + '</a>').join('') + '</div>';
            }
            return '';
          } catch { return ''; }
        })() : ''}
        ${!mySubmission.content && !mySubmission.attachments ? '<p class="text-muted mb-0">No content</p>' : ''}
      </div>
    </div>
    ` : ''}
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Due Date Card -->
    <div class="card mb-4">
      <div class="card-body text-center">
        <i class="bi bi-calendar-event fs-1 text-${assignment.dueDate && new Date(assignment.dueDate) < new Date() ? 'danger' : 'primary'} mb-2"></i>
        <h6 class="mb-1">Due Date</h6>
        ${assignment.dueDate ? '<p class="fs-5 mb-0 ' + (new Date(assignment.dueDate) < new Date() ? 'text-danger' : '') + '">' + new Date(assignment.dueDate).toLocaleDateString() + '</p><p class="text-muted mb-0">' + new Date(assignment.dueDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</p>' + (new Date(assignment.dueDate) < new Date() ? '<span class="badge bg-danger mt-2">Past Due</span>' : '') : '<p class="text-muted mb-0">No due date</p>'}
      </div>
    </div>

    <!-- Grade Card (if graded) -->
    ${mySubmission && mySubmission.status === 'graded' ? '<div class="card mb-4 border-success"><div class="card-body text-center"><i class="bi bi-award fs-1 text-success mb-2"></i><h6 class="mb-2">Your Grade</h6><div class="fs-1 fw-bold text-success">' + mySubmission.grade + '<small class="fs-5 text-muted">/' + assignment.maxPoints + '</small></div><div class="progress mt-2" style="height: 8px;"><div class="progress-bar bg-success" style="width: ' + Math.round((mySubmission.grade/assignment.maxPoints)*100) + '%"></div></div><p class="text-muted mt-2 mb-0">' + Math.round((mySubmission.grade/assignment.maxPoints)*100) + '%</p>' + (mySubmission.gradedBy ? '<small class="text-muted">Graded by ' + mySubmission.gradedBy.firstName + ' ' + mySubmission.gradedBy.lastName + '</small>' : '') + '</div></div>' : ''}

    <!-- Feedback (if any) -->
    ${mySubmission?.feedback ? '<div class="card mb-4"><div class="card-header bg-white"><h6 class="mb-0"><i class="bi bi-chat-quote me-2"></i>Teacher Feedback</h6></div><div class="card-body"><div style="white-space: pre-wrap;">' + mySubmission.feedback + '</div></div></div>' : ''}

    <!-- Submission Status -->
    ${mySubmission ? '<div class="card"><div class="card-body"><h6 class="mb-3">Submission Details</h6><p class="mb-2"><strong>Submitted:</strong><br>' + new Date(mySubmission.submittedAt).toLocaleString() + '</p>' + (mySubmission.isLate ? '<span class="badge bg-warning text-dark">Late Submission</span>' : '<span class="badge bg-success">On Time</span>') + '</div></div>' : ''}
  </div>
</div>
`, activePage: 'assignments', pageTitle: assignment.title, branding, user }) %>
