<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMS Settings - TutorAI Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { min-height: 100vh; max-height: 100vh; overflow-y: auto; position: sticky; top: 0; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'sms-settings', branding, basePath }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-chat-dots text-primary me-2"></i>SMS Settings</h2>
          <span class="badge <%= smsConfig.isEnabled ? 'bg-success' : 'bg-secondary' %> fs-6">
            <%= smsConfig.isEnabled ? 'Enabled' : 'Disabled' %>
          </span>
        </div>
        <p class="text-muted mb-4">Configure SMS notifications for students, parents, and teachers using Twilio.</p>

        <form action="<%= basePath %>/admin/sms-settings?token=<%= token %>" method="POST">
          <div class="row g-4">
            <!-- Twilio Configuration -->
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Twilio Configuration</h5>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Account SID <span class="text-danger">*</span></label>
                    <input type="text" name="accountSid" class="form-control" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" value="<%= smsConfig.accountSid %>">
                    <small class="text-muted">Find this in your Twilio Console</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Auth Token <span class="text-danger">*</span></label>
                    <input type="password" name="authToken" class="form-control" placeholder="Your auth token" value="<%= smsConfig.authToken %>">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                    <input type="tel" name="phoneNumber" class="form-control" placeholder="+1234567890" value="<%= smsConfig.phoneNumber %>">
                    <small class="text-muted">Your Twilio phone number</small>
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="isEnabled" id="smsEnabled" <%= smsConfig.isEnabled ? 'checked' : '' %>>
                    <label class="form-check-label" for="smsEnabled">Enable SMS Notifications</label>
                  </div>
                  <button type="button" class="btn btn-outline-secondary" onclick="testConnection()">
                    <i class="bi bi-plug me-1"></i>Test Connection
                  </button>
                </div>
              </div>
            </div>

            <!-- Notification Types -->
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Notification Types</h5>
                </div>
                <div class="card-body">
                  <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                      <div>
                        <strong>Session Reminders</strong>
                        <br><small class="text-muted">Remind students of upcoming sessions</small>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="sessionReminders" <%= smsConfig.sessionReminders ? 'checked' : '' %>>
                      </div>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                      <div>
                        <strong>Progress Updates</strong>
                        <br><small class="text-muted">Weekly progress reports to parents</small>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="progressUpdates" <%= smsConfig.progressUpdates ? 'checked' : '' %>>
                      </div>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                      <div>
                        <strong>Achievement Alerts</strong>
                        <br><small class="text-muted">Notify when student reaches milestone</small>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="achievementAlerts" <%= smsConfig.achievementAlerts ? 'checked' : '' %>>
                      </div>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                      <div>
                        <strong>Teacher Alerts</strong>
                        <br><small class="text-muted">Alert teacher when student struggles</small>
                      </div>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="teacherAlerts" <%= smsConfig.teacherAlerts ? 'checked' : '' %>>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Message Templates -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Message Templates</h5>
                </div>
                <div class="card-body">
                  <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Available Variables:</strong> {student_name}, {subject}, {sessions}, {mastery}, {topic}, {teacher_name}
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Session Reminder</label>
                      <textarea name="sessionReminderTemplate" class="form-control" rows="3"><%= smsConfig.sessionReminderTemplate %></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Progress Update</label>
                      <textarea name="progressUpdateTemplate" class="form-control" rows="3"><%= smsConfig.progressUpdateTemplate %></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Achievement Alert</label>
                      <textarea name="achievementTemplate" class="form-control" rows="3"><%= smsConfig.achievementTemplate %></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Teacher Alert</label>
                      <textarea name="teacherAlertTemplate" class="form-control" rows="3"><%= smsConfig.teacherAlertTemplate %></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Save Button -->
            <div class="col-12">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check-lg me-2"></i>Save SMS Settings
              </button>
            </div>
          </div>
        </form>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const basePath = '<%= basePath %>';
    const token = '<%= token %>';

    async function testConnection() {
      try {
        const response = await fetch(`${basePath}/admin/sms-settings/test?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        alert(result.success ? 'Connection successful: ' + result.message : 'Connection failed: ' + result.message);
      } catch (error) {
        alert('Test failed: ' + error.message);
      }
    }
  </script>
</body>
</html>
