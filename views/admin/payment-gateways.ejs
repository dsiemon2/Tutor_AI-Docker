<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Gateways - TutorAI Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { min-height: 100vh; max-height: 100vh; overflow-y: auto; position: sticky; top: 0; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
    .gateway-card { transition: all 0.2s ease; }
    .gateway-card:hover { transform: translateY(-2px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); }
    .badge-method { font-size: 0.7rem; margin-right: 0.25rem; }
    .copy-btn { cursor: pointer; }
    .copy-btn:hover { color: #0d6efd; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'payment-gateways', branding, basePath }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2><i class="bi bi-credit-card-2-front text-primary me-2"></i>Payment Gateways</h2>
            <p class="text-muted mb-0">Configure payment providers for subscription billing</p>
          </div>
          <button class="btn btn-outline-primary" id="testAllBtn" onclick="testAllConnections()">
            <i class="bi bi-plug"></i> Test All Connections
          </button>
        </div>

        <form id="gatewaysForm" method="POST">
          <div class="row g-4">
            <!-- Stripe -->
            <div class="col-md-6">
              <div class="card gateway-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-0"><i class="bi bi-stripe text-primary me-2"></i>Stripe</h5>
                    <small class="text-muted">Recommended for subscriptions</small>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="stripe[enabled]" id="stripeEnabled"
                      <%= gateways?.find(g => g.provider === 'stripe')?.isEnabled ? 'checked' : '' %>>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Publishable Key</label>
                    <input type="text" class="form-control" name="stripe[publishableKey]"
                      value="<%= gateways?.find(g => g.provider === 'stripe')?.publishableKey || '' %>" placeholder="pk_test_...">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Secret Key</label>
                    <input type="password" class="form-control" name="stripe[secretKey]"
                      value="<%= gateways?.find(g => g.provider === 'stripe')?.secretKey || '' %>" placeholder="sk_test_...">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Webhook Secret</label>
                    <input type="password" class="form-control" name="stripe[webhookSecret]"
                      value="<%= gateways?.find(g => g.provider === 'stripe')?.webhookSecret || '' %>" placeholder="whsec_...">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Webhook URL</label>
                    <div class="input-group">
                      <input type="text" class="form-control bg-light" readonly
                        value="<%= basePath %>/api/webhooks/stripe" id="stripeWebhookUrl">
                      <button class="btn btn-outline-secondary copy-btn" type="button" onclick="copyToClipboard('stripeWebhookUrl')">
                        <i class="bi bi-clipboard"></i>
                      </button>
                    </div>
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="stripe[testMode]" id="stripeTestMode"
                      <%= gateways?.find(g => g.provider === 'stripe')?.testMode !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="stripeTestMode">Test Mode</label>
                  </div>
                  <div class="mb-0">
                    <small class="text-muted">Supported Methods:</small><br>
                    <span class="badge bg-primary badge-method">Credit Cards</span>
                    <span class="badge bg-info badge-method">ACH Transfers</span>
                    <span class="badge bg-dark badge-method">Apple Pay</span>
                    <span class="badge bg-secondary badge-method">Google Pay</span>
                    <span class="badge bg-success badge-method">Link</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- PayPal -->
            <div class="col-md-6">
              <div class="card gateway-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-0"><i class="bi bi-paypal text-primary me-2"></i>PayPal</h5>
                    <small class="text-muted">Global payments</small>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="paypal[enabled]" id="paypalEnabled"
                      <%= gateways?.find(g => g.provider === 'paypal')?.isEnabled ? 'checked' : '' %>>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Client ID</label>
                    <input type="text" class="form-control" name="paypal[clientId]"
                      value="<%= gateways?.find(g => g.provider === 'paypal')?.clientId || '' %>" placeholder="AY...">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Client Secret</label>
                    <input type="password" class="form-control" name="paypal[clientSecret]"
                      value="<%= gateways?.find(g => g.provider === 'paypal')?.clientSecret || '' %>" placeholder="EG...">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Webhook ID</label>
                    <input type="text" class="form-control" name="paypal[webhookId]"
                      value="<%= gateways?.find(g => g.provider === 'paypal')?.webhookId || '' %>" placeholder="WH-...">
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="paypal[testMode]" id="paypalTestMode"
                      <%= gateways?.find(g => g.provider === 'paypal')?.testMode !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="paypalTestMode">Sandbox Mode</label>
                  </div>
                  <div class="mb-0">
                    <small class="text-muted">Supported Methods:</small><br>
                    <span class="badge bg-primary badge-method">PayPal Balance</span>
                    <span class="badge bg-info badge-method">Credit Cards</span>
                    <span class="badge bg-warning text-dark badge-method">Venmo</span>
                    <span class="badge bg-secondary badge-method">Pay Later</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Braintree -->
            <div class="col-md-6">
              <div class="card gateway-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-0"><i class="bi bi-credit-card me-2" style="color: #003087;"></i>Braintree</h5>
                    <small class="text-muted">PayPal subsidiary</small>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="braintree[enabled]" id="braintreeEnabled"
                      <%= gateways?.find(g => g.provider === 'braintree')?.isEnabled ? 'checked' : '' %>>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Merchant ID</label>
                    <input type="text" class="form-control" name="braintree[merchantId]"
                      value="<%= gateways?.find(g => g.provider === 'braintree')?.merchantId || '' %>">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Public Key</label>
                    <input type="text" class="form-control" name="braintree[publicKey]"
                      value="<%= gateways?.find(g => g.provider === 'braintree')?.publicKey || '' %>">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Private Key</label>
                    <input type="password" class="form-control" name="braintree[privateKey]"
                      value="<%= gateways?.find(g => g.provider === 'braintree')?.privateKey || '' %>">
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="braintree[testMode]" id="braintreeTestMode"
                      <%= gateways?.find(g => g.provider === 'braintree')?.testMode !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="braintreeTestMode">Sandbox Mode</label>
                  </div>
                  <div class="mb-0">
                    <small class="text-muted">Supported Methods:</small><br>
                    <span class="badge bg-primary badge-method">Credit Cards</span>
                    <span class="badge bg-info badge-method">PayPal</span>
                    <span class="badge bg-warning text-dark badge-method">Venmo</span>
                    <span class="badge bg-dark badge-method">Apple Pay</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Square -->
            <div class="col-md-6">
              <div class="card gateway-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-0"><i class="bi bi-square me-2" style="color: #006aff;"></i>Square</h5>
                    <small class="text-muted">In-person & online</small>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="square[enabled]" id="squareEnabled"
                      <%= gateways?.find(g => g.provider === 'square')?.isEnabled ? 'checked' : '' %>>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Application ID</label>
                    <input type="text" class="form-control" name="square[applicationId]"
                      value="<%= gateways?.find(g => g.provider === 'square')?.applicationId || '' %>" placeholder="sq0idp-...">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Access Token</label>
                    <input type="password" class="form-control" name="square[accessToken]"
                      value="<%= gateways?.find(g => g.provider === 'square')?.accessToken || '' %>" placeholder="EAAAE...">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Location ID</label>
                    <input type="text" class="form-control" name="square[locationId]"
                      value="<%= gateways?.find(g => g.provider === 'square')?.locationId || '' %>">
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="square[testMode]" id="squareTestMode"
                      <%= gateways?.find(g => g.provider === 'square')?.testMode !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="squareTestMode">Sandbox Mode</label>
                  </div>
                  <div class="mb-0">
                    <small class="text-muted">Supported Methods:</small><br>
                    <span class="badge bg-primary badge-method">Credit Cards</span>
                    <span class="badge bg-dark badge-method">Apple Pay</span>
                    <span class="badge bg-secondary badge-method">Google Pay</span>
                    <span class="badge bg-success badge-method">Cash App</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Authorize.net -->
            <div class="col-md-6">
              <div class="card gateway-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-0"><i class="bi bi-shield-check me-2" style="color: #1a4480;"></i>Authorize.net</h5>
                    <small class="text-muted">Enterprise solution</small>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="authorize[enabled]" id="authorizeEnabled"
                      <%= gateways?.find(g => g.provider === 'authorize')?.isEnabled ? 'checked' : '' %>>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">API Login ID</label>
                    <input type="text" class="form-control" name="authorize[apiLoginId]"
                      value="<%= gateways?.find(g => g.provider === 'authorize')?.apiLoginId || '' %>">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Transaction Key</label>
                    <input type="password" class="form-control" name="authorize[transactionKey]"
                      value="<%= gateways?.find(g => g.provider === 'authorize')?.transactionKey || '' %>">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Signature Key</label>
                    <input type="password" class="form-control" name="authorize[signatureKey]"
                      value="<%= gateways?.find(g => g.provider === 'authorize')?.signatureKey || '' %>">
                  </div>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="authorize[testMode]" id="authorizeTestMode"
                      <%= gateways?.find(g => g.provider === 'authorize')?.testMode !== false ? 'checked' : '' %>>
                    <label class="form-check-label" for="authorizeTestMode">Test Mode</label>
                  </div>
                  <div class="mb-0">
                    <small class="text-muted">Supported Methods:</small><br>
                    <span class="badge bg-primary badge-method">Credit Cards</span>
                    <span class="badge bg-info badge-method">eChecks</span>
                    <span class="badge bg-dark badge-method">Apple Pay</span>
                    <span class="badge bg-secondary badge-method">Digital Wallets</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-save me-2"></i>Save All Configurations
            </button>
          </div>
        </form>

        <!-- Provider Comparison -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Provider Comparison</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Provider</th>
                    <th>Transaction Fee</th>
                    <th>Monthly Fee</th>
                    <th>Best For</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><i class="bi bi-stripe text-primary me-2"></i>Stripe</td>
                    <td>2.9% + $0.30</td>
                    <td>$0</td>
                    <td>Subscriptions, SaaS</td>
                  </tr>
                  <tr>
                    <td><i class="bi bi-paypal text-primary me-2"></i>PayPal</td>
                    <td>2.9% + $0.30</td>
                    <td>$0</td>
                    <td>International, Consumer</td>
                  </tr>
                  <tr>
                    <td><i class="bi bi-credit-card me-2" style="color: #003087;"></i>Braintree</td>
                    <td>2.59% + $0.49</td>
                    <td>$0</td>
                    <td>Marketplaces, Mobile</td>
                  </tr>
                  <tr>
                    <td><i class="bi bi-square me-2" style="color: #006aff;"></i>Square</td>
                    <td>2.9% + $0.30</td>
                    <td>$0</td>
                    <td>In-Person + Online</td>
                  </tr>
                  <tr>
                    <td><i class="bi bi-shield-check me-2" style="color: #1a4480;"></i>Authorize.net</td>
                    <td>2.9% + $0.30</td>
                    <td>$25</td>
                    <td>Enterprise, High Volume</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const basePath = '<%= basePath %>';
    const token = '<%= token %>';

    function copyToClipboard(inputId) {
      const input = document.getElementById(inputId);
      navigator.clipboard.writeText(input.value);
      alert('Copied to clipboard!');
    }

    async function testAllConnections() {
      const btn = document.getElementById('testAllBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Testing...';

      try {
        const response = await fetch(`${basePath}/admin/payment-gateways/test?token=${token}`, {
          method: 'POST'
        });
        const results = await response.json();

        let message = 'Connection Test Results:\n\n';
        for (const [gateway, result] of Object.entries(results)) {
          message += `${gateway}: ${result.success ? '✓ Connected' : '✗ ' + result.message}\n`;
        }
        alert(message);
      } catch (error) {
        alert('Test failed: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plug"></i> Test All Connections';
      }
    }

    document.getElementById('gatewaysForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {};

      // Parse form data into gateway objects
      for (const [key, value] of formData.entries()) {
        const match = key.match(/(\w+)\[(\w+)\]/);
        if (match) {
          const [, gateway, field] = match;
          if (!data[gateway]) data[gateway] = {};
          if (field === 'enabled' || field === 'testMode') {
            data[gateway][field] = value === 'on';
          } else {
            data[gateway][field] = value;
          }
        }
      }

      // Set unchecked checkboxes to false
      ['stripe', 'paypal', 'braintree', 'square', 'authorize'].forEach(gw => {
        if (!data[gw]) data[gw] = {};
        if (data[gw].enabled === undefined) data[gw].enabled = false;
        if (data[gw].testMode === undefined) data[gw].testMode = false;
      });

      try {
        const response = await fetch(`${basePath}/admin/payment-gateways?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.success) {
          alert('Payment gateway settings saved successfully!');
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Save failed: ' + error.message);
      }
    });
  </script>
</body>
</html>
