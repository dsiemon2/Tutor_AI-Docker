<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: <%= branding.primaryColor %>;
      --secondary-color: <%= branding.secondaryColor %>;
    }
    body { background: #f8f9fa; }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 260px;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      padding: 1rem;
      overflow-y: auto;
      z-index: 1000;
    }
    .main-content {
      margin-left: 260px;
      padding: 2rem;
      min-height: 100vh;
    }
    .nav-link {
      color: rgba(255,255,255,0.8);
      border-radius: 8px;
      margin-bottom: 4px;
      padding: 0.6rem 1rem;
    }
    .nav-link:hover, .nav-link.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .stat-card {
      border: none;
      border-radius: 12px;
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    .badge-tier-bronze { color: #cd7f32; }
    .badge-tier-silver { color: #c0c0c0; }
    .badge-tier-gold { color: #ffd700; }
    .badge-tier-platinum { color: #e5e4e2; }
    .badge-tier-diamond { color: #b9f2ff; }
  </style>
</head>
<body>
  <%- include('_sidebar') %>

  <div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-trophy me-2"></i>Gamification</h2>
      <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
          <i class="bi bi-megaphone me-1"></i>New Announcement
        </button>
        <button class="btn btn-outline-primary" onclick="initializeBadges()">
          <i class="bi bi-arrow-repeat me-1"></i>Initialize Badges
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card stat-card bg-warning bg-opacity-10">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-warning bg-opacity-25 p-3 me-3">
                <i class="bi bi-award text-warning fs-4"></i>
              </div>
              <div>
                <h3 class="mb-0"><%= stats.badgeCount %></h3>
                <small class="text-muted">Available Badges</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-success bg-opacity-10">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-success bg-opacity-25 p-3 me-3">
                <i class="bi bi-star text-success fs-4"></i>
              </div>
              <div>
                <h3 class="mb-0"><%= stats.totalPointsIssued.toLocaleString() %></h3>
                <small class="text-muted">Points Issued</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-danger bg-opacity-10">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-danger bg-opacity-25 p-3 me-3">
                <i class="bi bi-fire text-danger fs-4"></i>
              </div>
              <div>
                <h3 class="mb-0"><%= stats.activeStreaks %></h3>
                <small class="text-muted">Active Streaks</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-info bg-opacity-10">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-info bg-opacity-25 p-3 me-3">
                <i class="bi bi-megaphone text-info fs-4"></i>
              </div>
              <div>
                <h3 class="mb-0"><%= stats.recentAnnouncements %></h3>
                <small class="text-muted">Active Announcements</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="gamificationTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#badges">
          <i class="bi bi-award me-1"></i>Badges
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#leaderboard">
          <i class="bi bi-bar-chart me-1"></i>Leaderboard
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#announcements">
          <i class="bi bi-megaphone me-1"></i>Announcements
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#points">
          <i class="bi bi-gear me-1"></i>Point Settings
        </a>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Badges Tab -->
      <div class="tab-pane fade show active" id="badges">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Badge Management</h5>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createBadgeModal">
              <i class="bi bi-plus me-1"></i>Create Badge
            </button>
          </div>
          <div class="card-body">
            <div class="row" id="badgesList">
              <!-- Badges loaded via JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- Leaderboard Tab -->
      <div class="tab-pane fade" id="leaderboard">
        <div class="card">
          <div class="card-header">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h5 class="mb-0">Leaderboard</h5>
              </div>
              <div class="col-md-6">
                <div class="row g-2">
                  <div class="col">
                    <select class="form-select form-select-sm" id="leaderboardScope">
                      <option value="global">Global</option>
                      <option value="school">By School</option>
                    </select>
                  </div>
                  <div class="col">
                    <select class="form-select form-select-sm" id="leaderboardPeriod">
                      <option value="all_time">All Time</option>
                      <option value="monthly">This Month</option>
                      <option value="weekly">This Week</option>
                      <option value="daily">Today</option>
                    </select>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-sm btn-primary" onclick="loadLeaderboard()">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th width="60">Rank</th>
                  <th>Student</th>
                  <th>School</th>
                  <th>Level</th>
                  <th class="text-end">Points</th>
                </tr>
              </thead>
              <tbody id="leaderboardBody">
                <!-- Loaded via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Announcements Tab -->
      <div class="tab-pane fade" id="announcements">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Announcements</h5>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
              <i class="bi bi-plus me-1"></i>New Announcement
            </button>
          </div>
          <div class="card-body p-0">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Type</th>
                  <th>Scope</th>
                  <th>Author</th>
                  <th>Published</th>
                  <th>Read</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="announcementsList">
                <!-- Loaded via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Point Settings Tab -->
      <div class="tab-pane fade" id="points">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Point Configuration</h5>
          </div>
          <div class="card-body">
            <form id="pointConfigForm">
              <div class="row g-4">
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Session Points</h6>
                  <div class="mb-3">
                    <label class="form-label">Session Complete</label>
                    <input type="number" class="form-control" name="sessionComplete" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Points per Minute</label>
                    <input type="number" class="form-control" name="sessionMinutes" min="0">
                  </div>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Quiz Points</h6>
                  <div class="mb-3">
                    <label class="form-label">Quiz Complete</label>
                    <input type="number" class="form-control" name="quizComplete" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Perfect Score Bonus</label>
                    <input type="number" class="form-control" name="quizPerfectScore" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Pass Bonus</label>
                    <input type="number" class="form-control" name="quizPassBonus" min="0">
                  </div>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Assignment Points</h6>
                  <div class="mb-3">
                    <label class="form-label">Submit Assignment</label>
                    <input type="number" class="form-control" name="assignmentSubmit" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">On-Time Bonus</label>
                    <input type="number" class="form-control" name="assignmentOnTime" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Perfect Grade Bonus</label>
                    <input type="number" class="form-control" name="assignmentPerfect" min="0">
                  </div>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Streak Bonuses</h6>
                  <div class="mb-3">
                    <label class="form-label">Daily Streak</label>
                    <input type="number" class="form-control" name="streakDaily" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">7-Day Streak</label>
                    <input type="number" class="form-control" name="streakWeekly" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">30-Day Streak</label>
                    <input type="number" class="form-control" name="streakMonthly" min="0">
                  </div>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-3">Mastery Points</h6>
                  <div class="mb-3">
                    <label class="form-label">Topic Mastered</label>
                    <input type="number" class="form-control" name="topicMastered" min="0">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Subject Complete</label>
                    <input type="number" class="form-control" name="subjectComplete" min="0">
                  </div>
                </div>
              </div>
              <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-check me-1"></i>Save Configuration
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Badge Modal -->
  <div class="modal fade" id="createBadgeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Badge</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="createBadgeForm">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Code (unique)</label>
              <input type="text" class="form-control" name="code" required pattern="[a-z0-9_]+">
            </div>
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="2"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" name="category">
                  <option value="achievement">Achievement</option>
                  <option value="streak">Streak</option>
                  <option value="mastery">Mastery</option>
                  <option value="social">Social</option>
                  <option value="special">Special</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Tier</label>
                <select class="form-select" name="tier">
                  <option value="bronze">Bronze</option>
                  <option value="silver">Silver</option>
                  <option value="gold">Gold</option>
                  <option value="platinum">Platinum</option>
                  <option value="diamond">Diamond</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Icon (Bootstrap)</label>
                <input type="text" class="form-control" name="icon" value="trophy">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Points</label>
                <input type="number" class="form-control" name="points" value="10" min="0">
              </div>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="isHidden" id="badgeHidden">
              <label class="form-check-label" for="badgeHidden">Hidden (surprise badge)</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Badge</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Create Announcement Modal -->
  <div class="modal fade" id="createAnnouncementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Announcement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="createAnnouncementForm">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Content</label>
              <textarea class="form-control" name="content" rows="4" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Type</label>
                <select class="form-select" name="type">
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Scope</label>
                <select class="form-select" name="scope">
                  <option value="all">All Users</option>
                  <option value="school">Specific School</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Expires At (optional)</label>
                <input type="datetime-local" class="form-control" name="expiresAt">
              </div>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" name="isPinned" id="announcePinned">
              <label class="form-check-label" for="announcePinned">Pin this announcement</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Publish Announcement</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const basePath = '<%= basePath %>';

    // Load all data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadBadges();
      loadLeaderboard();
      loadAnnouncements();
      loadPointConfig();
    });

    // Load badges
    async function loadBadges() {
      try {
        const response = await fetch(`${basePath}/admin/api/badges?includeHidden=true`);
        const badges = await response.json();

        const container = document.getElementById('badgesList');
        container.innerHTML = badges.map(badge => `
          <div class="col-md-3 mb-3">
            <div class="card h-100">
              <div class="card-body text-center">
                <i class="bi bi-${badge.icon} fs-1 badge-tier-${badge.tier}"></i>
                <h6 class="mt-2 mb-1">${badge.name}</h6>
                <small class="text-muted d-block">${badge.description}</small>
                <div class="mt-2">
                  <span class="badge bg-secondary">${badge.category}</span>
                  <span class="badge bg-${getTierColor(badge.tier)}">${badge.tier}</span>
                </div>
                <div class="mt-2">
                  <small class="text-success"><i class="bi bi-star"></i> ${badge.points} pts</small>
                  ${badge.isHidden ? '<span class="ms-2 badge bg-dark">Hidden</span>' : ''}
                </div>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading badges:', error);
      }
    }

    function getTierColor(tier) {
      const colors = { bronze: 'warning', silver: 'secondary', gold: 'warning', platinum: 'light', diamond: 'info' };
      return colors[tier] || 'secondary';
    }

    // Initialize default badges
    async function initializeBadges() {
      if (!confirm('This will create/update default badges. Continue?')) return;

      try {
        const response = await fetch(`${basePath}/admin/api/badges/initialize`, { method: 'POST' });
        if (response.ok) {
          alert('Badges initialized successfully!');
          loadBadges();
        }
      } catch (error) {
        console.error('Error initializing badges:', error);
      }
    }

    // Load leaderboard
    async function loadLeaderboard() {
      const scope = document.getElementById('leaderboardScope').value;
      const period = document.getElementById('leaderboardPeriod').value;

      try {
        const response = await fetch(`${basePath}/admin/api/leaderboard?scope=${scope}&period=${period}&limit=25`);
        const data = await response.json();

        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = data.map(entry => `
          <tr>
            <td>
              ${entry.rank <= 3 ? `<i class="bi bi-trophy-fill text-${entry.rank === 1 ? 'warning' : entry.rank === 2 ? 'secondary' : 'dark'}"></i>` : entry.rank}
            </td>
            <td>${entry.user?.firstName || 'Unknown'} ${entry.user?.lastName || ''}</td>
            <td>${entry.user?.school?.name || '-'}</td>
            <td><span class="badge bg-primary">Lvl ${entry.level || 1}</span></td>
            <td class="text-end fw-bold">${entry.points?.toLocaleString() || 0}</td>
          </tr>
        `).join('') || '<tr><td colspan="5" class="text-center text-muted">No data available</td></tr>';
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // Load announcements
    async function loadAnnouncements() {
      try {
        const response = await fetch(`${basePath}/admin/api/announcements?includeExpired=true`);
        const announcements = await response.json();

        const tbody = document.getElementById('announcementsList');
        tbody.innerHTML = announcements.map(a => `
          <tr>
            <td>
              ${a.isPinned ? '<i class="bi bi-pin-fill text-primary me-1"></i>' : ''}
              ${a.title}
            </td>
            <td><span class="badge bg-${getTypeColor(a.type)}">${a.type}</span></td>
            <td>${a.scope}${a.scopeId ? ` (${a.scopeId.slice(0, 8)}...)` : ''}</td>
            <td>${a.author?.firstName || 'System'}</td>
            <td>${new Date(a.publishAt).toLocaleDateString()}</td>
            <td>${a._count?.readBy || 0}</td>
            <td>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement('${a.id}')">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="7" class="text-center text-muted">No announcements</td></tr>';
      } catch (error) {
        console.error('Error loading announcements:', error);
      }
    }

    function getTypeColor(type) {
      const colors = { info: 'info', success: 'success', warning: 'warning', urgent: 'danger' };
      return colors[type] || 'secondary';
    }

    // Delete announcement
    async function deleteAnnouncement(id) {
      if (!confirm('Delete this announcement?')) return;

      try {
        await fetch(`${basePath}/admin/api/announcements/${id}`, { method: 'DELETE' });
        loadAnnouncements();
      } catch (error) {
        console.error('Error deleting announcement:', error);
      }
    }

    // Load point config
    async function loadPointConfig() {
      try {
        const response = await fetch(`${basePath}/admin/api/point-config`);
        const config = await response.json();

        const form = document.getElementById('pointConfigForm');
        Object.entries(config).forEach(([key, value]) => {
          const input = form.elements[key];
          if (input) input.value = value;
        });
      } catch (error) {
        console.error('Error loading point config:', error);
      }
    }

    // Create badge form
    document.getElementById('createBadgeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        code: formData.get('code'),
        name: formData.get('name'),
        description: formData.get('description'),
        category: formData.get('category'),
        tier: formData.get('tier'),
        icon: formData.get('icon'),
        points: parseInt(formData.get('points')) || 0,
        isHidden: formData.has('isHidden')
      };

      try {
        const response = await fetch(`${basePath}/admin/api/badges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          bootstrap.Modal.getInstance(document.getElementById('createBadgeModal')).hide();
          e.target.reset();
          loadBadges();
        }
      } catch (error) {
        console.error('Error creating badge:', error);
      }
    });

    // Create announcement form
    document.getElementById('createAnnouncementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title'),
        content: formData.get('content'),
        type: formData.get('type'),
        scope: formData.get('scope'),
        expiresAt: formData.get('expiresAt') || null,
        isPinned: formData.has('isPinned')
      };

      try {
        const response = await fetch(`${basePath}/admin/api/announcements`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          bootstrap.Modal.getInstance(document.getElementById('createAnnouncementModal')).hide();
          e.target.reset();
          loadAnnouncements();
        }
      } catch (error) {
        console.error('Error creating announcement:', error);
      }
    });

    // Point config form
    document.getElementById('pointConfigForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {};
      formData.forEach((value, key) => {
        data[key] = parseInt(value) || 0;
      });

      try {
        const response = await fetch(`${basePath}/admin/api/point-config`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('Point configuration saved!');
        }
      } catch (error) {
        console.error('Error saving point config:', error);
      }
    });
  </script>
</body>
</html>
