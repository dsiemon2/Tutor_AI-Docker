<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.1); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; text-transform: uppercase; padding: 0.5rem 1rem; }
    .plan-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { active, branding, token, basePath }) %>

      <main class="col-md-10 ms-sm-auto px-4 py-3">
        <h2 class="mb-4"><i class="bi bi-person-badge"></i> My Subscription</h2>

        <% if (subscription && currentPlan) { %>
          <!-- Current Subscription -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-star-fill"></i> Current Plan: <%= currentPlan.name %></h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <p class="mb-1 text-muted">Status</p>
                  <p class="fw-bold">
                    <% if (subscription.status === 'active') { %>
                      <span class="badge bg-success">Active</span>
                    <% } else if (subscription.status === 'trialing') { %>
                      <span class="badge bg-info">Trial</span>
                    <% } else if (subscription.status === 'canceled') { %>
                      <span class="badge bg-warning">Canceled</span>
                    <% } else { %>
                      <span class="badge bg-secondary"><%= subscription.status %></span>
                    <% } %>
                  </p>
                </div>
                <div class="col-md-4">
                  <p class="mb-1 text-muted">Billing Period</p>
                  <p class="fw-bold"><%= currentPlan.billingPeriod === 'yearly' ? 'Annual' : 'Monthly' %></p>
                </div>
                <div class="col-md-4">
                  <p class="mb-1 text-muted">Price</p>
                  <p class="fw-bold">$<%= currentPlan.price.toFixed(2) %>/<%= currentPlan.billingPeriod === 'yearly' ? 'year' : 'month' %></p>
                </div>
              </div>

              <hr>

              <div class="row">
                <div class="col-md-4">
                  <p class="mb-1 text-muted">Current Period Started</p>
                  <p class="fw-bold"><%= subscription.currentPeriodStart ? new Date(subscription.currentPeriodStart).toLocaleDateString() : 'N/A' %></p>
                </div>
                <div class="col-md-4">
                  <p class="mb-1 text-muted">Current Period Ends</p>
                  <p class="fw-bold"><%= subscription.currentPeriodEnd ? new Date(subscription.currentPeriodEnd).toLocaleDateString() : 'N/A' %></p>
                </div>
                <% if (subscription.trialEndsAt) { %>
                <div class="col-md-4">
                  <p class="mb-1 text-muted">Trial Ends</p>
                  <p class="fw-bold"><%= new Date(subscription.trialEndsAt).toLocaleDateString() %></p>
                </div>
                <% } %>
              </div>

              <hr>

              <div class="d-flex gap-2">
                <a href="<%= basePath %>/admin/pricing?token=<%= token %>" class="btn btn-outline-primary">
                  <i class="bi bi-arrow-up-circle"></i> Change Plan
                </a>
                <% if (subscription.status === 'active') { %>
                  <button class="btn btn-outline-danger" onclick="cancelSubscription()">
                    <i class="bi bi-x-circle"></i> Cancel Subscription
                  </button>
                <% } else if (subscription.status === 'canceled') { %>
                  <button class="btn btn-outline-success" onclick="resumeSubscription()">
                    <i class="bi bi-arrow-repeat"></i> Resume Subscription
                  </button>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Plan Features -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-check2-square"></i> Plan Features</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <ul class="list-unstyled">
                    <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Sessions per month: <%= currentPlan.sessionsPerMonth || 'Unlimited' %></li>
                    <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Subjects: <%= currentPlan.subjectsAllowed || 'All' %></li>
                  </ul>
                </div>
                <% if (currentPlan.features) { %>
                  <% const features = JSON.parse(currentPlan.features || '[]'); %>
                  <div class="col-md-6">
                    <ul class="list-unstyled">
                      <% features.forEach(feature => { %>
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <%= feature %></li>
                      <% }) %>
                    </ul>
                  </div>
                <% } %>
              </div>
            </div>
          </div>

        <% } else { %>
          <!-- No Subscription -->
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="bi bi-gift display-1 text-muted"></i>
              <h4 class="mt-3">No Active Subscription</h4>
              <p class="text-muted">Choose a plan to unlock all features and get started.</p>
              <a href="<%= basePath %>/admin/pricing?token=<%= token %>" class="btn btn-primary btn-lg">
                <i class="bi bi-tags"></i> View Pricing Plans
              </a>
            </div>
          </div>
        <% } %>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const basePath = '<%= basePath %>';
    const token = '<%= token %>';

    async function cancelSubscription() {
      if (!confirm('Are you sure you want to cancel your subscription? You will still have access until the end of your current billing period.')) {
        return;
      }

      try {
        const res = await fetch(`${basePath}/admin/subscription/cancel?token=${token}`, {
          method: 'POST'
        });
        const result = await res.json();
        if (result.success) {
          alert(result.message);
          location.reload();
        } else {
          alert(result.error || 'Failed to cancel subscription');
        }
      } catch (err) {
        alert('Error canceling subscription');
      }
    }

    async function resumeSubscription() {
      try {
        const res = await fetch(`${basePath}/admin/subscription/resume?token=${token}`, {
          method: 'POST'
        });
        const result = await res.json();
        if (result.success) {
          alert(result.message);
          location.reload();
        } else {
          alert(result.error || 'Failed to resume subscription');
        }
      } catch (err) {
        alert('Error resuming subscription');
      }
    }
  </script>
</body>
</html>
