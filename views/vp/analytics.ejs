<%- include('../layouts/vp', { body: `
<!-- Summary Stats -->
<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="stat-card">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stat-label">Sessions (Last 30 Days)</div>
          <div class="stat-value">${summary?.totalSessions || 0}</div>
        </div>
        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
          <i class="bi bi-chat-dots"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="stat-card">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="stat-label">Avg Session Duration</div>
          <div class="stat-value">${summary?.avgSessionDuration || 0} sec</div>
        </div>
        <div class="stat-icon bg-info bg-opacity-10 text-info">
          <i class="bi bi-clock"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Sessions by Subject -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Sessions by Subject</h5>
      </div>
      <div class="card-body">
        ${sessionsBySubject && sessionsBySubject.length > 0 ? sessionsBySubject.map(s => {
          const maxCount = Math.max(...sessionsBySubject.map(x => x._count?.id || 0));
          const percentage = maxCount > 0 ? Math.round((s._count?.id || 0) / maxCount * 100) : 0;
          return '<div class="mb-3"><div class="d-flex justify-content-between mb-1"><span>' + (s.subjectName || 'General') + '</span><span class="text-muted">' + (s._count?.id || 0) + ' sessions</span></div><div class="progress" style="height: 10px;"><div class="progress-bar bg-primary" style="width: ' + percentage + '%;"></div></div></div>';
        }).join('') : '<div class="text-center text-muted py-4"><i class="bi bi-bar-chart fs-1 d-block mb-2"></i>No session data available</div>'}
      </div>
    </div>
  </div>

  <!-- Students by Grade -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Students by Grade</h5>
      </div>
      <div class="card-body">
        ${studentsByGrade && studentsByGrade.length > 0 ? studentsByGrade.sort((a, b) => (a.gradeLevel || 0) - (b.gradeLevel || 0)).map(g => {
          const maxCount = Math.max(...studentsByGrade.map(x => x._count?.id || 0));
          const percentage = maxCount > 0 ? Math.round((g._count?.id || 0) / maxCount * 100) : 0;
          const gradeLabel = g.gradeLevel === -2 ? 'Pre-K 3' : g.gradeLevel === -1 ? 'Pre-K 4' : g.gradeLevel === 0 ? 'Kindergarten' : 'Grade ' + g.gradeLevel;
          return '<div class="mb-3"><div class="d-flex justify-content-between mb-1"><span>' + gradeLabel + '</span><span class="text-muted">' + (g._count?.id || 0) + ' students</span></div><div class="progress" style="height: 10px;"><div class="progress-bar bg-success" style="width: ' + percentage + '%;"></div></div></div>';
        }).join('') : '<div class="text-center text-muted py-4"><i class="bi bi-people fs-1 d-block mb-2"></i>No student data available</div>'}
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-2">
  <!-- Progress Distribution -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Progress Distribution</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          ${(() => {
            const ranges = [
              { min: 0, max: 25, label: '0-25%', color: 'danger' },
              { min: 26, max: 50, label: '26-50%', color: 'warning' },
              { min: 51, max: 75, label: '51-75%', color: 'info' },
              { min: 76, max: 100, label: '76-100%', color: 'success' }
            ];
            return ranges.map(r => {
              const count = progressDistribution ? progressDistribution.filter(p => p.masteryLevel >= r.min && p.masteryLevel <= r.max).reduce((sum, p) => sum + (p._count?.id || 0), 0) : 0;
              return '<div class="col-3"><div class="fs-4 fw-bold text-' + r.color + '">' + count + '</div><small class="text-muted">' + r.label + '</small></div>';
            }).join('');
          })()}
        </div>
      </div>
    </div>
  </div>

  <!-- Top Performing Students -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Top Performing Students</h5>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          ${topStudents && topStudents.length > 0 ? topStudents.slice(0, 5).map((student, index) => {
            const medals = ['bi-trophy-fill text-warning', 'bi-trophy-fill text-secondary', 'bi-trophy text-warning', 'bi-award text-info', 'bi-award text-info'];
            return '<a href="' + (typeof basePath !== 'undefined' ? basePath : '') + '/vp/students/' + student.id + '" class="list-group-item list-group-item-action"><div class="d-flex justify-content-between align-items-center"><div class="d-flex align-items-center gap-3"><i class="bi ' + (medals[index] || 'bi-person') + '"></i><div><strong>' + student.firstName + ' ' + student.lastName + '</strong><br><small class="text-muted">Grade ' + (student.gradeLevel || 'N/A') + '</small></div></div><span class="badge bg-success">' + student.avgMastery + '% avg</span></div></a>';
          }).join('') : '<div class="p-4 text-center text-muted"><i class="bi bi-trophy fs-1 d-block mb-2"></i>No data available</div>'}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart placeholder for future enhancement -->
<div class="row g-4 mt-2">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Sessions Over Time (Last 30 Days)</h5>
      </div>
      <div class="card-body">
        <div class="text-center text-muted py-4">
          <i class="bi bi-graph-up-arrow fs-1 d-block mb-2"></i>
          <p>Session activity visualization</p>
          <small class="text-muted">Total sessions tracked: ${sessionsOverTime?.length || 0} data points</small>
        </div>
      </div>
    </div>
  </div>
</div>
`, activePage: 'analytics', pageTitle: 'Analytics' }) %>
