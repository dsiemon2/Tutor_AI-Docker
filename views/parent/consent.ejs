<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .navbar { background: linear-gradient(135deg, <%= branding.primaryColor %> 0%, <%= branding.secondaryColor %> 100%); }
    .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
    .consent-verified { border-left: 4px solid #22c55e; }
    .consent-pending { border-left: 4px solid #eab308; }
    .consent-revoked { border-left: 4px solid #ef4444; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
      <a class="navbar-brand" href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/parent">
        <i class="bi bi-mortarboard-fill me-2"></i>TutorAI Parent Portal
      </a>
      <div class="d-flex align-items-center">
        <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/parent/settings" class="btn btn-outline-light btn-sm me-2">
          <i class="bi bi-arrow-left me-1"></i>Back to Settings
        </a>
        <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/parent/logout" class="btn btn-outline-light btn-sm">
          <i class="bi bi-box-arrow-right"></i>
        </a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2 class="mb-4"><i class="bi bi-shield-check me-2"></i>Consent Management</h2>

    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5><i class="bi bi-info-circle me-2 text-info"></i>About Parental Consent</h5>
            <p class="mb-0">Under the Children's Online Privacy Protection Act (COPPA), we require verifiable parental consent before collecting personal information from children under 13. Here you can view and manage consent for your children.</p>
          </div>
        </div>
      </div>
    </div>

    <% if (consents.length === 0) { %>
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="bi bi-shield text-muted fs-1"></i>
        <p class="text-muted mt-3">No consent records found for your account.</p>
      </div>
    </div>
    <% } else { %>
    <div class="row">
      <% consents.forEach(consent => { %>
      <div class="col-md-6 mb-4">
        <div class="card consent-<%= consent.consentStatus %>">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <% if (consent.student) { %>
              <%= consent.student.firstName %> <%= consent.student.lastName %>
              <% } else { %>
              Child Account
              <% } %>
            </h6>
            <span class="badge bg-<%= consent.consentStatus === 'verified' ? 'success' : consent.consentStatus === 'pending' ? 'warning' : 'danger' %>">
              <%= consent.consentStatus.charAt(0).toUpperCase() + consent.consentStatus.slice(1) %>
            </span>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-6">
                <small class="text-muted d-block">Child's Age</small>
                <strong><%= consent.childAge %> years old</strong>
              </div>
              <div class="col-6">
                <small class="text-muted d-block">Requested</small>
                <strong><%= new Date(consent.requestedAt).toLocaleDateString() %></strong>
              </div>
            </div>

            <% if (consent.consentStatus === 'verified') { %>
            <div class="row mb-3">
              <div class="col-6">
                <small class="text-muted d-block">Verified</small>
                <strong><%= consent.verifiedAt ? new Date(consent.verifiedAt).toLocaleDateString() : 'N/A' %></strong>
              </div>
              <div class="col-6">
                <small class="text-muted d-block">Method</small>
                <strong><%= consent.consentMethod %></strong>
              </div>
            </div>

            <hr>

            <h6 class="mb-3">Privacy Preferences</h6>
            <div class="mb-2">
              <i class="bi bi-<%= consent.allowDataCollection ? 'check-circle text-success' : 'x-circle text-danger' %> me-2"></i>
              Data Collection
            </div>
            <div class="mb-2">
              <i class="bi bi-<%= consent.allowThirdPartySharing ? 'check-circle text-success' : 'x-circle text-danger' %> me-2"></i>
              Third-Party Sharing
            </div>
            <div class="mb-3">
              <i class="bi bi-<%= consent.allowMarketing ? 'check-circle text-success' : 'x-circle text-danger' %> me-2"></i>
              Marketing Communications
            </div>

            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#revokeModal<%= consent.id %>">
              <i class="bi bi-x-circle me-1"></i>Revoke Consent
            </button>
            <% } %>

            <% if (consent.consentStatus === 'pending') { %>
            <div class="alert alert-warning mb-0">
              <i class="bi bi-hourglass-split me-2"></i>
              Awaiting verification. Please check your email.
            </div>
            <% } %>

            <% if (consent.consentStatus === 'revoked') { %>
            <div class="alert alert-danger mb-0">
              <i class="bi bi-x-circle me-2"></i>
              Revoked on <%= consent.revokedAt ? new Date(consent.revokedAt).toLocaleDateString() : 'N/A' %>
              <% if (consent.revokedReason) { %>
              <br><small>Reason: <%= consent.revokedReason %></small>
              <% } %>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Revoke Modal -->
      <div class="modal fade" id="revokeModal<%= consent.id %>" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Revoke Consent</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="<%= typeof basePath !== 'undefined' ? basePath : '' %>/parent/consent/<%= consent.id %>/revoke">
              <div class="modal-body">
                <div class="alert alert-warning">
                  <strong>Warning:</strong> Revoking consent will:
                  <ul class="mb-0 mt-2">
                    <li>Prevent your child from using the tutoring service</li>
                    <li>Stop all data collection for your child</li>
                    <li>This action cannot be easily undone</li>
                  </ul>
                </div>
                <div class="mb-3">
                  <label class="form-label">Reason for revoking (optional)</label>
                  <textarea class="form-control" name="reason" rows="3" placeholder="Please tell us why you're revoking consent..."></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Revoke Consent</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <% }); %>
    </div>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
